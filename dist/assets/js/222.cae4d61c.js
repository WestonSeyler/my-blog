(window.webpackJsonp=window.webpackJsonp||[]).push([[222],{659:function(s,e,t){"use strict";t.r(e);var n=t(30),a=Object(n.a)({},(function(){var s=this,e=s.$createElement,t=s._self._c||e;return t("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[t("p",[t("strong",[s._v("更新 2021-06-15")]),s._v("\n为防止恶意触发，建议在Jenkins->configure Generic Webhook Trigger 中配置white list 添加IP地址，即只接受这个IP去请求webhook地址")]),s._v(" "),t("p",[t("strong",[s._v("更新 2019-07-14")])]),s._v(" "),t("p",[s._v("关于webhook触发job，其实有更简单的办法，在job的配置页面\n勾选"),t("code",[s._v("Build Triggers")]),s._v("选项卡的"),t("code",[s._v("Trigger builds remotely (e.g., from scripts)")]),s._v('，填入一个token，但是有时候会报\n"Error 403 No valid crumb was included in the request"个人觉得还是Generic Webhook Trigger插件好用')]),s._v(" "),t("p",[t("img",{attrs:{src:"https://hexo-blog.pek3b.qingstor.com/upload_images/71414-fe35644cd7d95c18.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240",alt:"image.png"}})]),s._v(" "),t("p",[s._v("比如job名称是foo，token是123456，webhook地址就是"),t("code",[s._v("JENKINS_URL/job/=foo/build?token=123456")]),s._v("\n经测无论是get还是post请求都可以成功触发。当然如果你的需求更高，需要根据请求头请求或地址中的参数有条件的触发，就可以用Generic Webhook Trigger插件。")]),s._v(" "),t("p",[s._v("如果返回'Authentication required'请检查地址中的token是否正确，还需要保证在Jenkins的'Configure Global Security'配置页面勾选了'Allow anonymous read access'。")]),s._v(" "),t("p",[s._v("需求：我的博客是用hexo搭建的，每次提交完代码都需要在托管的服务器上执行手动发布命令\n"),t("code",[s._v("deploy.sh")])]),s._v(" "),t("div",{staticClass:"language-bash line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-bash"}},[t("code",[t("span",{pre:!0,attrs:{class:"token function"}},[s._v("git")]),s._v(" pull\n"),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("npm")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("install")]),s._v("\nhexo g "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 生成静态文件")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br")])]),t("p",[s._v("现在我需要Jenkins的Generic Webhook Trigger插件来帮我自动完成这些工作。")]),s._v(" "),t("p",[s._v("Generic Webhook Trigger 是 Jenkins 提供的一款插件，装好这个插件后会暴露出一个URL地址，格式如 "),t("code",[s._v("JENKINS_URL/generic-webhook-trigger/invoke")]),s._v("。")]),s._v(" "),t("p",[s._v("我们往这个地址发请求，请求体或请求头带上要构建的job名称，分支名称等信息，这个插件可以正则提取出这些信息，当作变量进而触发构建。")]),s._v(" "),t("p",[s._v("大致流程如下图：\n"),t("img",{attrs:{src:"https://hexo-blog.pek3b.qingstor.com/upload_images/71414-f018c0080855947f.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240",alt:"image.png"}})]),s._v(" "),t("ol",[t("li",[t("p",[s._v("在Jenkins插件管理页面搜索该插件\n"),t("img",{attrs:{src:"https://hexo-blog.pek3b.qingstor.com/upload_images/71414-d77b6049e189a7dd.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240",alt:"image.png"}})])]),s._v(" "),t("li",[t("p",[s._v('安装之后新建一个item，类型选freestyle，pipeline都行，在 Build Trigger 选项卡中会看到多出了一项 "Generic Webhook Trigger"，勾选之后多出了很多信息。这里只填写Token\n'),t("img",{attrs:{src:"https://hexo-blog.pek3b.qingstor.com/upload_images/71414-297d21a4fc3de0d4.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240",alt:"image.png"}})])]),s._v(" "),t("li",[t("p",[s._v("这里我创建的是个Pipeline的job，pipeline script 就是调用"),t("code",[s._v("deploy.sh")]),s._v("。注意这里我的博客和Jenkins都部署在了同一台服务器上面。")])])]),s._v(" "),t("div",{staticClass:"language-groovy line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-groovy"}},[t("code",[s._v("pipeline "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    agent any\n    "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 避免 npm install 报权限问题")]),s._v("\n    environment "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        PATH"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token string gstring"}},[s._v('"/bin:/sbin:/usr/bin:/usr/sbin:/usr/local/bin"')]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n    stages "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("stage")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'build'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n            steps "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n                sh "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'node -v'")]),s._v("\n                sh "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'npm -v'")]),s._v("\n                dir "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string gstring"}},[s._v('"/var/www/www.mafeifan.com/"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n                   sh "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'git pull'")]),s._v("\n                   sh "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'npm install'")]),s._v("\n                   sh "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'hexo g'")]),s._v("\n                "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n            "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br")])]),t("ol",{attrs:{start:"4"}},[t("li",[t("p",[s._v("来到Gitee/Github，添加一个webhook地址，如果你的Jenkins地址是http://110.110.110.110:8080，job名称为gitee-hexo-blog-pipeline，\n那么根据规则，Generic Webhook Trigger的地址是"),t("code",[s._v("http://110.110.110.110:8080/generic-webhook-trigger/invoke?token=gitee-hexo-blog-pipeline")]),s._v("\n配置完成，点测试，看返回内容是否是成功的。\n"),t("img",{attrs:{src:"https://hexo-blog.pek3b.qingstor.com/upload_images/71414-7621263f95c91bad.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240",alt:"image.png"}})])]),s._v(" "),t("li",[t("p",[s._v("测试，我们修改代码内容，并且push，发现Jenkins果然自动触发了build。")])])]),s._v(" "),t("p",[t("img",{attrs:{src:"https://hexo-blog.pek3b.qingstor.com/upload_images/71414-ce3208259e56d384.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240",alt:"image.png"}})]),s._v(" "),t("ol",{attrs:{start:"6"}},[t("li",[s._v("如果我们需要限制分支，比如只有往develop上push代码才触发，\n在 Build Triggers 选项卡中填写 Post content parameters 内容。\n即将请求体中的ref内容提取出来赋给$ref\n"),t("img",{attrs:{src:"https://hexo-blog.pek3b.qingstor.com/upload_images/71414-8c73eeabccc02e99.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240",alt:"image.png"}})])]),s._v(" "),t("p",[s._v("然后在 Optional filter 选项卡中填写要过滤的分支名称。 Expression 填写正则 "),t("code",[s._v("^(refs/heads/develop)$")]),s._v(", Text 可以填写变量 "),t("code",[s._v("$ref")]),s._v(" "),t("img",{attrs:{src:"https://hexo-blog.pek3b.qingstor.com/upload_images/71414-fa46cc29d7484c83.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240",alt:"image.png"}})]),s._v(" "),t("p",[s._v("测试时候建议用Postman。触发地址 GWT 会告诉咱们，请求体可以在仓库托管平台获取，然后手动修改内容进行测试\n"),t("img",{attrs:{src:"https://hexo-blog.pek3b.qingstor.com/upload_images/71414-a0f9c88de0969c78.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240",alt:"image.png"}})])])}),[],!1,null,null,null);e.default=a.exports}}]);