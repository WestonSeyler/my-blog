(window.webpackJsonp=window.webpackJsonp||[]).push([[84],{522:function(s,n,e){"use strict";e.r(n);var a=e(30),t=Object(a.a)({},(function(){var s=this,n=s.$createElement,e=s._self._c||n;return e("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[e("p",[s._v("先看 "),e("a",{attrs:{href:"https://d.laravel-china.org/docs/5.5/middleware",target:"_blank",rel:"noopener noreferrer"}},[s._v("文档"),e("OutboundLink")],1),s._v("\nLaravel 中间件提供了一种方便的机制来过滤进入应用的 HTTP 请求。\n这里实现一个只有admin角色才能访问特定路由的功能")]),s._v(" "),e("ol",[e("li",[e("p",[s._v("新建middleware\n"),e("code",[s._v("php artisan make:middleware MustBeAdmin")])])]),s._v(" "),e("li",[e("p",[s._v("打开生成的 "),e("code",[s._v("\\app\\Http\\Middleware\\MustBeAdmin.php")]),s._v(" 修改handle方法\n关于hasRole方法上一篇有讲解\n这里在请求前判断用户角色是否是admin，如果条件满足进到下一个中间件。不满足返回首页。")])])]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("    public function handle($request, Closure $next)\n    {\n    \t   // 前置\n\t    if ($request->user()->hasRole('admin')) {\n\t\t    return $next($request);\n\t    }\n\t    return redirect('/');\n    }\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br")])]),e("ol",{attrs:{start:"3"}},[e("li",[e("p",[s._v("让系统识别中间件。打开 "),e("code",[s._v("\\app\\Http\\Kernel")]),s._v("\n在 $routeMiddleware 数组里追加\n"),e("code",[s._v("'mustAdmin' => \\App\\Http\\Middleware\\MustBeAdmin::class,")])])]),s._v(" "),e("li",[e("p",[s._v("关于中间件的调用非常灵活，比如")])])]),s._v(" "),e("ul",[e("li",[s._v("在 routes\\web.php 中\n"),e("code",[s._v("Route::resource('posts', 'PostsController')->middleware('mustAdmin');")])]),s._v(" "),e("li",[s._v("在控制器中")])]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("class PostsController extends Controller\n{\n\n\tpublic function __construct()\n\t{\n\t\t$this->middleware('mustAdmin', ['only' => 'show']);\n\t}\n...\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br")])]),e("ol",{attrs:{start:"5"}},[e("li",[s._v("项目中用到过的中间件")])]),s._v(" "),e("h3",{attrs:{id:"例1"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#例1"}},[s._v("#")]),s._v(" 例1")]),s._v(" "),e("p",[s._v("在route中定义哪些角色可以访问，通过 "),e("code",[s._v("role:ADMIN,TEACHER")]),s._v(" 知，role是中间件名字，后面的 "),e("code",[s._v("ADMIN,TEACHER")]),s._v(" 是参数。\nroutes.php")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("Route::group(['middleware' => ['web', 'auth', 'role:ADMIN,TEACHER'], 'namespace' => '\\StudentTrac\\Guides\\Controllers'],\n    function () {\n        Route::resource('guides', 'GuidesController', ['only' => ['index']]);\n        Route::resource('guides/admin', 'AdminController', ['only' => ['index', 'edit']]);\n    }\n);\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br")])]),e("p",[s._v("/app/Http/Middleware/Role.php")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("    public function handle($request, Closure $next, $role)\n    {\n        //  ['ADMIN', 'TEACHER']\n    \t$roles = func_get_args();\n    \t$roleIds = [];\n        // 根据role名字拿到对应的id\n\t\tforeach ($roles as $index => $role) {\n            // 为什么这么判断我也忘了\n\t\t\tif ($index < 2) continue;\n\t\t\t$roleIds[] = config('roles.' . trim($role));\n\t\t}\n\n        // 判断当前用户的roleId是否存在\n        if (! in_array((int)$this->auth->user()->RoleId, $roleIds)) {\n            return response('Unauthorized', 403);\n        }\n\n        return $next($request);\n    }\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br"),e("span",{staticClass:"line-number"},[s._v("17")]),e("br"),e("span",{staticClass:"line-number"},[s._v("18")]),e("br"),e("span",{staticClass:"line-number"},[s._v("19")]),e("br")])]),e("p",[s._v("config/roles.php")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("return [\n    /*\n     * Role id for role.\n     */\n    'ADMIN'    => 1,\n    'STUDENT'  => 2,\n    'GUARDIAN' => 3,\n    'TEACHER'  => 4,\n    'SUPPORTSTAFF' => 5,\n    'AUDITOR' => 6,\n    'CURRICULUM' => 7,\n    'CLIENTADMINISTRATOR' => 8,\n];\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br")])])])}),[],!1,null,null,null);n.default=t.exports}}]);