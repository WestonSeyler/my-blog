(window.webpackJsonp=window.webpackJsonp||[]).push([[295],{733:function(s,t,n){"use strict";n.r(t);var a=n(30),e=Object(a.a)({},(function(){var s=this,t=s.$createElement,n=s._self._c||t;return n("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[n("p",[s._v("对于Angular项目，之前处理一个ticket的流程我们的做法：")]),s._v(" "),n("ol",[n("li",[s._v("启动项目本地开发 "),n("code",[s._v("npm start")])]),s._v(" "),n("li",[s._v("开发完成，跑代码语法及规范检测 "),n("code",[s._v("npm run lint")])]),s._v(" "),n("li",[s._v("跑单元测试 "),n("code",[s._v("npm run test")])]),s._v(" "),n("li",[s._v("构建生产静态资源 "),n("code",[s._v("npm run build")])]),s._v(" "),n("li",[s._v("打包然后上传到服务器 "),n("code",[s._v("tar -zcvf oneportal.gz -C dist .")])])]),s._v(" "),n("p",[s._v("每处理完一个任务都得搞一遍是不是很麻烦?重复而且效率低")]),s._v(" "),n("p",[s._v("这种事情完全可以交给CircleCI来处理。不用自己买服务器，比Jenkins简单。省去了维护和部署。\nCircleCI的好处(截止当前的政策2019.2)：")]),s._v(" "),n("ol",[n("li",[s._v("每月构建时长1000分钟以内免费 (基本够用)")]),s._v(" "),n("li",[s._v("提供的构建环境配置2核CPU / 4G内存，(算是很慷慨了)\n据测试如果是在1核1G的主机下执行npm run build很容易报内存不足")]),s._v(" "),n("li",[s._v("有专门的配置文件来定义work flow，而且还很强大。")])]),s._v(" "),n("h4",{attrs:{id:"具体实现"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#具体实现"}},[s._v("#")]),s._v(" 具体实现")]),s._v(" "),n("p",[s._v("Angular项目根目录新建"),n("code",[s._v(".circleci")]),s._v("目录(注意以点开头)，然后在这个目录里面再新建"),n("code",[s._v("config.yml")]),s._v("文件\n下面是我正在使用的配置，具体语法可以见"),n("a",{attrs:{href:"https://circleci.com/docs/2.0/sample-config/#section=configuration",target:"_blank",rel:"noopener noreferrer"}},[s._v("官方介绍"),n("OutboundLink")],1)]),s._v(" "),n("div",{staticClass:"language-yaml line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-yaml"}},[n("code",[n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# Check https://circleci.com/docs/2.0/language-javascript/ for more details")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# See: https://github.com/ci-samples/angular-cli-circleci/blob/master/.circleci/config.yml")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("version")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("\n"),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("jobs")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("build")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("docker")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# Specify service dependencies here if necessary")]),s._v("\n      "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# CircleCI maintains a library of pre-built images")]),s._v("\n      "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# documented at https://circleci.com/docs/2.0/circleci-images/")]),s._v("\n      "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# specify the version you desire here")]),s._v("\n      "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# - image: circleci/node:10.14-browsers")]),s._v("\n      "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("image")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" finleyma/circleci"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("nodejs"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("browser"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("awscli\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("working_directory")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" ~/repo\n    "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# https://circleci.com/docs/2.0/env-vars/")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("environment")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("ANGULAR_BUILD_DIR")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" ~/repo/dist\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("steps")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" checkout\n      "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# Download and cache dependencies")]),s._v("\n      "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("restore_cache")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n          "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("keys")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n            "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" v1"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("dependencies"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v(' checksum "package.json" '),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n            "),n("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# fallback to using the latest cache if no exact match is found")]),s._v("\n            "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" v1"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("dependencies"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("\n      "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("run")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n          "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" install"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("dependencies\n          "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("command")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" npm install\n      "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("run")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" node "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("v\n      "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("run")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" npm "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("v\n      "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("run")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" npm run lint\n      "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("run")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" npm run ci"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("test\n      "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("run")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" npm run ci"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("build\n      "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("run")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" tar "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("zcvf oneportal.gz "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("C dist .\n      "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("save_cache")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n          "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("paths")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n            "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" node_modules\n          "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("key")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" v1"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("dependencies"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v(' checksum "package.json" '),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n      "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("run")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" aws "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("version\n      "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("run")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n          "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("name")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" upload"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("to"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("aws"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("s3\n          "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("command")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[s._v("'aws s3 cp oneportal.gz s3://your-aws-bucket/path/ --region us-east-1'")]),s._v("\n\n"),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("workflows")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("version")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("\n  "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("build-deploy")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n    "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("jobs")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n      "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("build")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n          "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("filters")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n            "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("branches")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v("\n              "),n("span",{pre:!0,attrs:{class:"token key atrule"}},[s._v("only")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(":")]),s._v(" daily"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v("build\n")])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br"),n("span",{staticClass:"line-number"},[s._v("8")]),n("br"),n("span",{staticClass:"line-number"},[s._v("9")]),n("br"),n("span",{staticClass:"line-number"},[s._v("10")]),n("br"),n("span",{staticClass:"line-number"},[s._v("11")]),n("br"),n("span",{staticClass:"line-number"},[s._v("12")]),n("br"),n("span",{staticClass:"line-number"},[s._v("13")]),n("br"),n("span",{staticClass:"line-number"},[s._v("14")]),n("br"),n("span",{staticClass:"line-number"},[s._v("15")]),n("br"),n("span",{staticClass:"line-number"},[s._v("16")]),n("br"),n("span",{staticClass:"line-number"},[s._v("17")]),n("br"),n("span",{staticClass:"line-number"},[s._v("18")]),n("br"),n("span",{staticClass:"line-number"},[s._v("19")]),n("br"),n("span",{staticClass:"line-number"},[s._v("20")]),n("br"),n("span",{staticClass:"line-number"},[s._v("21")]),n("br"),n("span",{staticClass:"line-number"},[s._v("22")]),n("br"),n("span",{staticClass:"line-number"},[s._v("23")]),n("br"),n("span",{staticClass:"line-number"},[s._v("24")]),n("br"),n("span",{staticClass:"line-number"},[s._v("25")]),n("br"),n("span",{staticClass:"line-number"},[s._v("26")]),n("br"),n("span",{staticClass:"line-number"},[s._v("27")]),n("br"),n("span",{staticClass:"line-number"},[s._v("28")]),n("br"),n("span",{staticClass:"line-number"},[s._v("29")]),n("br"),n("span",{staticClass:"line-number"},[s._v("30")]),n("br"),n("span",{staticClass:"line-number"},[s._v("31")]),n("br"),n("span",{staticClass:"line-number"},[s._v("32")]),n("br"),n("span",{staticClass:"line-number"},[s._v("33")]),n("br"),n("span",{staticClass:"line-number"},[s._v("34")]),n("br"),n("span",{staticClass:"line-number"},[s._v("35")]),n("br"),n("span",{staticClass:"line-number"},[s._v("36")]),n("br"),n("span",{staticClass:"line-number"},[s._v("37")]),n("br"),n("span",{staticClass:"line-number"},[s._v("38")]),n("br"),n("span",{staticClass:"line-number"},[s._v("39")]),n("br"),n("span",{staticClass:"line-number"},[s._v("40")]),n("br"),n("span",{staticClass:"line-number"},[s._v("41")]),n("br"),n("span",{staticClass:"line-number"},[s._v("42")]),n("br"),n("span",{staticClass:"line-number"},[s._v("43")]),n("br"),n("span",{staticClass:"line-number"},[s._v("44")]),n("br"),n("span",{staticClass:"line-number"},[s._v("45")]),n("br"),n("span",{staticClass:"line-number"},[s._v("46")]),n("br"),n("span",{staticClass:"line-number"},[s._v("47")]),n("br"),n("span",{staticClass:"line-number"},[s._v("48")]),n("br"),n("span",{staticClass:"line-number"},[s._v("49")]),n("br"),n("span",{staticClass:"line-number"},[s._v("50")]),n("br"),n("span",{staticClass:"line-number"},[s._v("51")]),n("br")])]),n("p",[s._v("需要解释几点：")]),s._v(" "),n("ol",[n("li",[s._v("使用的Docker镜像是"),n("a",{attrs:{href:"https://cloud.docker.com/u/finleyma/repository/docker/finleyma/circleci-nodejs-browser-awscli",target:"_blank",rel:"noopener noreferrer"}},[s._v("finleyma/circleci-nodejs-browser-awscli"),n("OutboundLink")],1),s._v("，这是我基于CircleCI的镜像又加入了awscli工具。这个镜像包含了node10, Chrome(为了跑单元测试), Python2.7(为了安装AWS CLI), AWS CLI(为了上传打包后的静态资源)")]),s._v(" "),n("li",[s._v("大致流程就是开头说的，只不过为了统一环境我们的项目是在Docker容器里跑测试和构建。通过之后将打包的待发布的静态资源上传到AWS存储。\n还有配置文件里限制了分支，只有往daily-build分支上合并代码才会触发CircleCI的构建。")]),s._v(" "),n("li",[s._v("其中"),n("code",[s._v("npm run ci-test")]),s._v("和"),n("code",[s._v("npm run ci-build")]),s._v("\n需要在项目的package.json定义好，加入了一些参数，比如不输出过程，和加入环境参数配置")])]),s._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[s._v('    "start": "npm run proxy",\n     ...\n    "build": "ng build --prod",\n    "test": "ng test --configuration=testing",\n    "ci-build": "node --max_old_space_size=4096 node_modules/@angular/cli/bin/ng build --configuration=dev --watch=false --progress=false",\n    "ci-test": "ng test --configuration=testing --watch=false --browsers=ChromeHeadless --progress=false",\n    "lint": "ng lint",\n')])]),s._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[s._v("1")]),n("br"),n("span",{staticClass:"line-number"},[s._v("2")]),n("br"),n("span",{staticClass:"line-number"},[s._v("3")]),n("br"),n("span",{staticClass:"line-number"},[s._v("4")]),n("br"),n("span",{staticClass:"line-number"},[s._v("5")]),n("br"),n("span",{staticClass:"line-number"},[s._v("6")]),n("br"),n("span",{staticClass:"line-number"},[s._v("7")]),n("br")])]),n("ol",{attrs:{start:"4"}},[n("li",[s._v("需要在CircleCI后台配置AWS的Key和Secret。")])]),s._v(" "),n("p",[s._v("当然，你可以直接通过SSH将项目传到站点服务器部署。也需要在后台配置下访问服务器的Key。")]),s._v(" "),n("h4",{attrs:{id:"效果"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#效果"}},[s._v("#")]),s._v(" 效果：")]),s._v(" "),n("blockquote",[n("p",[n("img",{attrs:{src:"https://hexo-blog.pek3b.qingstor.com/upload_images/71414-2a865e72eb496816.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240",alt:"image.png"}})])])])}),[],!1,null,null,null);t.default=e.exports}}]);