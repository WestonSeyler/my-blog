(window.webpackJsonp=window.webpackJsonp||[]).push([[108],{553:function(s,n,e){"use strict";e.r(n);var t=e(30),a=Object(t.a)({},(function(){var s=this,n=s.$createElement,e=s._self._c||n;return e("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[e("p",[s._v("2018-04-12 更新pm2的权限问题")]),s._v(" "),e("p",[s._v("PM2 的功能不多做介绍了，总之使用简单，功能强大。\n今天实现了本地自动部署node项目到服务器的流程。简单总结下几个注意点。\n建议先看 "),e("a",{attrs:{href:"http://pm2.keymetrics.io/docs/usage/deployment/#getting-started",target:"_blank",rel:"noopener noreferrer"}},[s._v("文档"),e("OutboundLink")],1)]),s._v(" "),e("ol",[e("li",[s._v("先要保证要部署的服务器上(以下简称server)能直接ssh拉仓库代码，比如 "),e("code",[s._v("git clone git@gitee.com:finley/demo.git")]),s._v("。不行的话配下server生成ssh-key，然后把public key存到代码仓库服务商，比如coding.net, github。")]),s._v(" "),e("li",[s._v("权限问题，比如服务器的登录用户是ubuntu，将来项目要部署在/home/ubuntu下面，可以执行下 "),e("code",[s._v("sudo chown ubuntu:ubuntu /home/ubuntu/.pm2/*")]),s._v(" 不然可能会部署失败。")]),s._v(" "),e("li",[s._v("部署成功后会在配置的项目路径里出现以下三个目录：")])]),s._v(" "),e("blockquote",[e("p",[s._v("current   -- 当前服务运行的文件夹(是source的软链接)\nshare        -- log pid 等共享数据\nsource   -- clone 下来的源代码")])]),s._v(" "),e("ol",{attrs:{start:"4"}},[e("li",[s._v("配置脚本")])]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("module.exports = {\n  /**\n   * Application configuration section\n   * http://pm2.keymetrics.io/docs/usage/application-declaration/\n   */\n  apps : [\n    {\n      name      : 'NODE-API',\n      script    : 'server.js',\n      // 这里是公共变量\n      env: {\n          SERVER_PORT: 8081,\n      },\n      env_development: {\n        NODE_ENV: 'development',\n      },\n      env_production : {\n        NODE_ENV: 'production',\n      }\n    }\n  ],\n\n  /**\n   * Deployment section\n   * http://pm2.keymetrics.io/docs/usage/deployment/\n   */\n  deploy : {\n    // 项目信息\n    // 下面的配置是我用什么用户登录哪个服务器，从哪拉代码，项目存到什么位置。拉完执行的脚本是啥\n    'master' : {\n      user : 'ubuntu',\n      // 写成数组，可以同时部署到多台服务器\n      host : '119.254.xxx.xxx',\n      ref  : 'origin/master',\n      repo : 'ssh://git@demo.com/demo.git',\n      // 项目的存放地址，会生成current, source, share目录\n      path : '/home/ubuntu/node-project',\n      // \"ssh_options\": [\"StrictHostKeyChecking=no\", \"PasswordAuthentication=no\"],\n      \"post-deploy\" : 'npm install && pm2 startOrRestart ecosystem.config.js --env production'\n    }\n  }\n};\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br"),e("span",{staticClass:"line-number"},[s._v("17")]),e("br"),e("span",{staticClass:"line-number"},[s._v("18")]),e("br"),e("span",{staticClass:"line-number"},[s._v("19")]),e("br"),e("span",{staticClass:"line-number"},[s._v("20")]),e("br"),e("span",{staticClass:"line-number"},[s._v("21")]),e("br"),e("span",{staticClass:"line-number"},[s._v("22")]),e("br"),e("span",{staticClass:"line-number"},[s._v("23")]),e("br"),e("span",{staticClass:"line-number"},[s._v("24")]),e("br"),e("span",{staticClass:"line-number"},[s._v("25")]),e("br"),e("span",{staticClass:"line-number"},[s._v("26")]),e("br"),e("span",{staticClass:"line-number"},[s._v("27")]),e("br"),e("span",{staticClass:"line-number"},[s._v("28")]),e("br"),e("span",{staticClass:"line-number"},[s._v("29")]),e("br"),e("span",{staticClass:"line-number"},[s._v("30")]),e("br"),e("span",{staticClass:"line-number"},[s._v("31")]),e("br"),e("span",{staticClass:"line-number"},[s._v("32")]),e("br"),e("span",{staticClass:"line-number"},[s._v("33")]),e("br"),e("span",{staticClass:"line-number"},[s._v("34")]),e("br"),e("span",{staticClass:"line-number"},[s._v("35")]),e("br"),e("span",{staticClass:"line-number"},[s._v("36")]),e("br"),e("span",{staticClass:"line-number"},[s._v("37")]),e("br"),e("span",{staticClass:"line-number"},[s._v("38")]),e("br"),e("span",{staticClass:"line-number"},[s._v("39")]),e("br"),e("span",{staticClass:"line-number"},[s._v("40")]),e("br"),e("span",{staticClass:"line-number"},[s._v("41")]),e("br"),e("span",{staticClass:"line-number"},[s._v("42")]),e("br")])]),e("ol",{attrs:{start:"5"}},[e("li",[s._v("执行命令, 如果是windows，在CMD中执行没用，建议在 git bash下执行。\n先初始化下，这里会尝试远程登录服务器并建立项目目录，如果失败通常是ssh问题。\n所以先在服务器上试试git clone能否成功，如果拉不下来，考虑服务器防火墙限制或ssh配置\n"),e("code",[s._v("pm2 deploy ecosystem.config.js master setup")]),s._v("\n这个命令只是拉仓库代码\n"),e("code",[s._v("pm2 deploy ecosystem.config.js master")]),s._v("\n这个命令会执行 配置文件的 post-deploy 部分，最终运行项目")])]),s._v(" "),e("h3",{attrs:{id:"pm2-reload-和pm2-restart-有啥区别"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#pm2-reload-和pm2-restart-有啥区别"}},[s._v("#")]),s._v(" pm2 reload 和pm2 restart 有啥区别")]),s._v(" "),e("p",[s._v("官方说明：As opposed to restart, which kills and restarts the process, reload achieves a 0-second-downtime reload.\n简单理解：\nrestart = stop+start\nreload 会更优雅一些\n具体用哪个要根据项目运行实际情况，有些项目需要7*24运行，不得stop，这时候用reload比较好。")]),s._v(" "),e("h3",{attrs:{id:"权限问题"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#权限问题"}},[s._v("#")]),s._v(" 权限问题")]),s._v(" "),e("p",[s._v("使用 "),e("code",[s._v("sudo pm2 start ecosystem.config.js")]),s._v(" 和 "),e("code",[s._v("pm2 start ecosystem.config.js")]),s._v(" 启动项目是有区别的，前者用户可能是root，后者是当前用户。建议不加sudo启动。我们在服务器上操作pm2 list, pm2 logs非常频繁。如果非得加sudo和密码才能成功。\n可以 "),e("code",[s._v("sudo visudo")]),s._v(" 然后追加"),e("code",[s._v("ubuntu ALL=(ALL) NOPASSWD:ALL")]),s._v(" ubuntu 是不希望输入密码的用户名。")])])}),[],!1,null,null,null);n.default=a.exports}}]);