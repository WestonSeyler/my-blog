(window.webpackJsonp=window.webpackJsonp||[]).push([[220],{657:function(s,n,t){"use strict";t.r(n);var a=t(30),e=Object(a.a)({},(function(){var s=this,n=s.$createElement,t=s._self._c||n;return t("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[t("p",[s._v("环境变量可以被看作是pipeline与Jenkins交互的媒介。比如，可以在pipeline中通过BUILD_ NUMBER变量知道构建任务的当前构建次数。环境变量可以分为Jenkins内置变量和自定义变量。")]),s._v(" "),t("h4",{attrs:{id:"jenkins内置变量"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#jenkins内置变量"}},[s._v("#")]),s._v(" Jenkins内置变量")]),s._v(" "),t("p",[s._v("在pipeline执行时，Jenkins通过一个名为env的全局变量，将Jenkins内置环境变量暴露出来。其使用方法有多种，示例如下:")]),s._v(" "),t("div",{staticClass:"language-groovy line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-groovy"}},[t("code",[s._v("pipeline "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  agent any\n  stages "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("stage")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'Example'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n      steps "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n         echo "),t("span",{pre:!0,attrs:{class:"token string gstring"}},[s._v('"Running '),t("span",{pre:!0,attrs:{class:"token expression"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("$")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("env"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("BUILDNUMBER"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")])]),s._v(" on "),t("span",{pre:!0,attrs:{class:"token expression"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("$")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("env"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("JENKINS_URL"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")])]),s._v('"')]),s._v(" # 方法"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("1")]),s._v("\n         echo "),t("span",{pre:!0,attrs:{class:"token string gstring"}},[s._v('"Running '),t("span",{pre:!0,attrs:{class:"token expression"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("$")]),s._v("env"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("BUILDNUMBER")]),s._v(" on "),t("span",{pre:!0,attrs:{class:"token expression"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("$")]),s._v("env"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("JENKINS_URL")]),s._v('"')]),s._v("  # 方法"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("2")]),s._v("\n         echo "),t("span",{pre:!0,attrs:{class:"token string gstring"}},[s._v('"Running '),t("span",{pre:!0,attrs:{class:"token expression"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("$")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("BUILDNUMBER"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")])]),s._v(" on "),t("span",{pre:!0,attrs:{class:"token expression"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("$")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("JENKINS_URL"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")])]),s._v('"')]),s._v("   # 方法"),t("span",{pre:!0,attrs:{class:"token number"}},[s._v("3")]),s._v(" 不推荐，难排查\n      "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br")])]),t("p",[s._v("默认env的属性可以直接在pipeline中引用。所以以上方法都是合法的。但是不推荐方法三，因为出现变量冲突时，非常难查问题。")]),s._v(" "),t("p",[s._v("那么，env变量都有哪些可用属性呢?\n通过访问"),t("code",[s._v("<Jenkins master的地址>/pipeline-syntax/globals#env")]),s._v('来获取完整列表。在列表中，当一个变量被声明为"For a multibranch project"时，代表只有多分支项目才会有此变量。')]),s._v(" "),t("blockquote",[t("p",[t("img",{attrs:{src:"https://hexo-blog.pek3b.qingstor.com/upload_images/71414-baabcdac51cce97a.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240",alt:"image.png"}})])]),s._v(" "),t("p",[s._v("下面我们简单介绍几个在实际工作中经常用到的变量:")]),s._v(" "),t("ul",[t("li",[s._v("BUILD_ NUMBER：构建号，累加的数字。在打包时，它可作为制品名称的一部分，比如server-2.jar。")]),s._v(" "),t("li",[s._v("BRANCH_ NAME：多分支pipeline项目支持。当需要根据不同的分支做不同的事情时就会用到，比如通过代码将release分支发布到生产环境中、master分支发布到测试环境中。")]),s._v(" "),t("li",[s._v("BUILD_ URL：当前构建的页面URL。如果构建失败，则需要将失败的构建链接放在邮件通知中，这个链接就可以是BUILD _URL。")]),s._v(" "),t("li",[s._v("GIT BRANCH：通过git拉取的源码构建的项目才会有此变量。")])]),s._v(" "),t("p",[s._v("在使用"),t("code",[s._v("env变量")]),s._v("时，需要注意不同类型的项目，"),t("code",[s._v("env变量")]),s._v("所包含的属性及其值是不一样的。比如普通pipeline任务中的GIT BRANCH变量的值为"),t("code",[s._v("origin/master")]),s._v("，而在多分支pipeline任务中GIT BRANCH变量的值为master。")]),s._v(" "),t("p",[s._v("所以，在pipeline中根据分支进行不同行为的逻辑处理时，需要留意。")]),s._v(" "),t("h4",{attrs:{id:"自定义变量"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#自定义变量"}},[s._v("#")]),s._v(" 自定义变量")]),s._v(" "),t("ol",[t("li",[s._v("pipeline提供的environment指令中定义")])]),s._v(" "),t("div",{staticClass:"language-groovy line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-groovy"}},[t("code",[s._v("pipeline "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    agent any\n    environment "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("// 覆盖默认的PATH变量值")]),s._v("\n        PATH"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token string gstring"}},[s._v('"/bin:/sbin:/usr/bin:/usr/sbin:/usr/local/bin"')]),s._v("\n        name"),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'jack'")]),s._v("\n    "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n    stages "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("stage")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token string gstring"}},[s._v('"test env"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n          steps "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n            sh "),t("span",{pre:!0,attrs:{class:"token string gstring"}},[s._v('"printenv"')]),s._v("  #调试，打印所有env变量\n            echo "),t("span",{pre:!0,attrs:{class:"token string gstring"}},[s._v('"'),t("span",{pre:!0,attrs:{class:"token expression"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("$")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("name"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")])]),s._v('"')]),s._v("  # jack\n            echo "),t("span",{pre:!0,attrs:{class:"token string gstring"}},[s._v('"'),t("span",{pre:!0,attrs:{class:"token expression"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("$")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("env"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(".")]),s._v("name"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")])]),s._v('"')]),s._v("  # jack\n          "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n        "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n     "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br")])]),t("p",[s._v("environment指令可以用在pipeline中定义，作用域就是整个pipeline，当定义在stage阶段，只在当前stage有效。")]),s._v(" "),t("ol",{attrs:{start:"2"}},[t("li",[s._v("环境变量的互相引用")])]),s._v(" "),t("div",{staticClass:"language-groovy line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-groovy"}},[t("code",[s._v("environment "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  __server_name "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'email-server'")]),s._v("\n  __version "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string gstring"}},[s._v('"'),t("span",{pre:!0,attrs:{class:"token expression"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("$")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("BUILD_NUMBER"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")])]),s._v('"')]),s._v("\n  __artifact_name "),t("span",{pre:!0,attrs:{class:"token operator"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token string gstring"}},[s._v('"'),t("span",{pre:!0,attrs:{class:"token expression"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("$")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("__server_name"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")])]),s._v("-"),t("span",{pre:!0,attrs:{class:"token expression"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("$")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("__version"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")])]),s._v('.jar"')]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br")])]),t("div",{staticClass:"custom-block tip"},[t("p",{staticClass:"custom-block-title"},[s._v("TIP")]),s._v(" "),t("ol",[t("li",[s._v("在调试pipeline时，可以再开始阶段加一句 "),t("code",[s._v("sh 'printenv'")]),s._v(" 将所有env变量打印出来。")]),s._v(" "),t("li",[s._v("自定义变量时，为避免命名冲突，可根据项目或公司加上统一前缀，如"),t("code",[s._v("__server_name")]),s._v("，__就是前缀。")])])]),s._v(" "),t("ol",{attrs:{start:"3"}},[t("li",[s._v("自定义全局环境变量\n定义全局环境变量可以跨pipeline使用\n进入Jenkins -- Manage Jenkins -- 找到Global properties -- 勾选Environment variables")])]),s._v(" "),t("blockquote",[t("p",[t("img",{attrs:{src:"https://hexo-blog.pek3b.qingstor.com/upload_images/71414-76eb6395b3d648ae.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240",alt:"image.png"}})])]),s._v(" "),t("p",[s._v("自定义全局环境变量会被加入env属性列表中，所以使用时可以直接用"),t("code",[s._v("${env.g_name}")]),s._v("引用。")]),s._v(" "),t("h4",{attrs:{id:"脚本式pipeline"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#脚本式pipeline"}},[s._v("#")]),s._v(" 脚本式pipeline")]),s._v(" "),t("p",[s._v("上面的例子都是定义式pipeline，下面的例子是脚本式")]),s._v(" "),t("div",{staticClass:"language-groovy line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-groovy"}},[t("code",[s._v("node "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("/* .. snip .. */")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token function"}},[s._v("withEnv")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("(")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token string gstring"}},[s._v('"PATH+MAVEN='),t("span",{pre:!0,attrs:{class:"token expression"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("$")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("tool "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'M3'")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")])]),s._v('/bin"')]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v(")")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("{")]),s._v("\n    sh "),t("span",{pre:!0,attrs:{class:"token string"}},[s._v("'mvn -B verify'")]),s._v("\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("}")]),s._v("\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br")])])])}),[],!1,null,null,null);n.default=e.exports}}]);