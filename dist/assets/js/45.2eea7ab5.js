(window.webpackJsonp=window.webpackJsonp||[]).push([[45],{481:function(s,n,e){"use strict";e.r(n);var a=e(30),t=Object(a.a)({},(function(){var s=this,n=s.$createElement,e=s._self._c||n;return e("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[e("p",[s._v("在做前后台分离的项目中，认证是必须的，由于http是无状态的。前台用户登录成功后，后台给前台返回token。之后前台给后台发请求每次携带token。")]),s._v(" "),e("p",[s._v("原理也非常简单：")]),s._v(" "),e("ol",[e("li",[s._v("前天在请求头中添加 Authorization，如下\n"),e("img",{attrs:{src:"https://hexo-blog.pek3b.qingstor.com/upload_images/71414-ea6a4988a773de40.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240",alt:"image.png"}})]),s._v(" "),e("li",[s._v("后台取到值，然后去用户表的api_token列进行匹配，如果查到说明验证成功，并且返回相关信息。")])]),s._v(" "),e("p",[s._v("Laravel本身自带几种验证方式，下面介绍下token认证的实现的方法。")]),s._v(" "),e("p",[s._v("前台在向后台发起请求时要携带一个token")]),s._v(" "),e("p",[s._v("后台需要做一个返回当前登录用户的信息的api，地址是 "),e("code",[s._v("/api/user")])]),s._v(" "),e("ol",[e("li",[s._v("先添加路由，当给 route/api.php 添加")])]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("Route::middleware('auth:api')->get('/user', function (Request $request) {\n\techo $request->user();\n});\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br")])]),e("p",[s._v("如果浏览器直接访问 "),e("code",[s._v("http://mydomain.com/api/user")]),s._v(" 会返回 "),e("code",[s._v("401 Unauthorized")]),s._v("\n原因是在config/auth.php中有下面的关键配置")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("    'guards' => [\n        'web' => [\n            'driver' => 'session',\n            'provider' => 'users',\n        ],\n\n        'api' => [\n            'driver' => 'token',\n            'provider' => 'users',\n        ],\n    ],\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br")])]),e("p",[s._v("可以看到通过api访问走的是token认证，这里没有提供token所以就认证失败返回401了。")]),s._v(" "),e("ol",{attrs:{start:"2"}},[e("li",[e("code",[s._v("'driver' => 'token'")]),s._v(" 实际调用的是"),e("code",[s._v("\\vendor\\laravel\\framework\\src\\Illuminate\\Auth\\TokenGuard.php")]),s._v("\n上面说到我们需要在request里提供api_token参数，为了区别是哪个用户，需要在user表添加api_token字段")])]),s._v(" "),e("p",[e("img",{attrs:{src:"https://hexo-blog.pek3b.qingstor.com/upload_images/71414-613f209f9c859b58.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240",alt:"image.png"}})]),s._v(" "),e("ol",{attrs:{start:"3"}},[e("li",[s._v("认证过程调用的是getTokenForRequest方法")])]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("    public function getTokenForRequest()\n    {\n        $token = $this->request->query($this->inputKey);\n\n        if (empty($token)) {\n            $token = $this->request->input($this->inputKey);\n        }\n\n        if (empty($token)) {\n            $token = $this->request->bearerToken();\n        }\n\n        if (empty($token)) {\n            $token = $this->request->getPassword();\n        }\n\n        return $token;\n    }\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br"),e("span",{staticClass:"line-number"},[s._v("17")]),e("br"),e("span",{staticClass:"line-number"},[s._v("18")]),e("br")])]),e("p",[s._v("这个bearerToken实际找header中是否存在Authorization")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("    public function bearerToken()\n    {\n        $header = $this->header('Authorization', '');\n\n        if (Str::startsWith($header, 'Bearer ')) {\n            return Str::substr($header, 7);\n        }\n    }\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br")])]),e("ol",{attrs:{start:"4"}},[e("li",[s._v("先给user表添加api_token字段\n"),e("code",[s._v("php artisan make:migration add_api_token_to_users --table=users")]),s._v("\n内容")])]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("class AddApiTokenToUsers extends Migration\n{\n    /**\n     * Run the migrations.\n     *\n     * @return void\n     */\n    public function up()\n    {\n        Schema::table('users', function (Blueprint $table) {\n\t        $table->string('api_token', 60)->unique();\n        });\n    }\n\n    /**\n     * Reverse the migrations.\n     *\n     * @return void\n     */\n    public function down()\n    {\n        Schema::table('users', function (Blueprint $table) {\n            $table->dropColumn('api_token');\n        });\n    }\n}\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br"),e("span",{staticClass:"line-number"},[s._v("17")]),e("br"),e("span",{staticClass:"line-number"},[s._v("18")]),e("br"),e("span",{staticClass:"line-number"},[s._v("19")]),e("br"),e("span",{staticClass:"line-number"},[s._v("20")]),e("br"),e("span",{staticClass:"line-number"},[s._v("21")]),e("br"),e("span",{staticClass:"line-number"},[s._v("22")]),e("br"),e("span",{staticClass:"line-number"},[s._v("23")]),e("br"),e("span",{staticClass:"line-number"},[s._v("24")]),e("br"),e("span",{staticClass:"line-number"},[s._v("25")]),e("br"),e("span",{staticClass:"line-number"},[s._v("26")]),e("br")])]),e("ol",{attrs:{start:"5"}},[e("li",[e("p",[s._v("打开navicat进到user表里，更新users的api_token。\n"),e("img",{attrs:{src:"https://hexo-blog.pek3b.qingstor.com/upload_images/71414-9c4143b8d15b29e1.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240",alt:"image.png"}})])]),s._v(" "),e("li",[e("p",[s._v("打开postman\n"),e("img",{attrs:{src:"https://hexo-blog.pek3b.qingstor.com/upload_images/71414-1ae37e4bab785fcc.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240",alt:"image.png"}}),s._v("\n注意这里的header，key是Authorization，值就是Bearer+空格+刚才数据库里设的api_token")])])]),s._v(" "),e("p",[s._v("这样就能返回内容啦，修改其他用户的token能返回相应的用户信息，说明认证成功，功能基本完成！\n下面完善细节")]),s._v(" "),e("ol",{attrs:{start:"7"}},[e("li",[s._v("完善逻辑\n修改 "),e("code",[s._v("\\app\\Http\\Controllers\\Auth\\RegisterController.php")])])]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("    protected function create(array $data)\n    {\n        return User::create([\n            'name' => $data['name'],\n            'email' => $data['email'],\n            'password' => bcrypt($data['password']),\n            // 添加这行\n\t        'api_token' => str_random(60),\n        ]);\n    }\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br")])]),e("p",[s._v("User Model 的 $fillable也改下")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("    protected $fillable = [\n        'name', 'email', 'password', 'api_token',\n    ];\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br")])]),e("ol",{attrs:{start:"8"}},[e("li",[s._v("如果在前台页面，发起请求时如何给后台传这个Authorization header? 方法如下\n注意，下面的是Laravel5.4的修改方法。新版本可能有细微区别，只要知道原理就能自己改了。")])]),s._v(" "),e("p",[s._v("打开 "),e("code",[s._v("\\resources\\assets\\js\\bootstrap.js")]),s._v(" 参照着csrf-token。合适的地方添加下面的代码")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("let token     = document.head.querySelector('meta[name=\"csrf-token\"]');\nlet api_token = document.head.querySelector('meta[name=\"api-token\"]');\n\nif (token) {\n    // 这个要参考axios的文档\n    window.axios.defaults.headers.common['X-CSRF-TOKEN'] = Laravel.csrfToken =token.content;\n    // 如果用的jquery\n    // Fix jquery ajax crossDomain without Token\n    // jQuery.ajaxPrefilter(function (options, originalOptions, jqXHR) {\n    //     // if (options.crossDomain) {\n    //     jqXHR.setRequestHeader('Authorization', api_token.content);\n    //     jqXHR.setRequestHeader('X-CSRF-TOKEN', token.content);\n    //     //}\n    // });\n} else {\n    console.error('CSRF token not found: https://laravel.com/docs/csrf#csrf-x-csrf-token');\n}\n\n\nif (api_token) {\n    window.axios.defaults.headers.common['Authorization'] = api_token.content;\n} else {\n    console.error('Authorization token not found: https://laravel.com/docs/csrf#csrf-x-csrf-token');\n}\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br"),e("span",{staticClass:"line-number"},[s._v("17")]),e("br"),e("span",{staticClass:"line-number"},[s._v("18")]),e("br"),e("span",{staticClass:"line-number"},[s._v("19")]),e("br"),e("span",{staticClass:"line-number"},[s._v("20")]),e("br"),e("span",{staticClass:"line-number"},[s._v("21")]),e("br"),e("span",{staticClass:"line-number"},[s._v("22")]),e("br"),e("span",{staticClass:"line-number"},[s._v("23")]),e("br"),e("span",{staticClass:"line-number"},[s._v("24")]),e("br")])]),e("p",[s._v("最后修改公共视图模版中 "),e("code",[s._v("\\views\\layouts\\app.blade.php")])]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v('    <meta name="csrf-token" content="{{ csrf_token() }}">\n    <meta name="api-token" content="{{ Auth::check() ? \'Bearer \'.Auth::user()->api_token : \'Bearer \' }}">\n')])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br")])]),e("p",[s._v("总结：\n本质上给用户表添加api_token，后台根据这个字段判断是否是有效的用户，无效返回401，有效返回查询结果。\n优点是容易理解，缺点太简单，安全也不够。\n为了安全，可以实现下面的功能：")]),s._v(" "),e("ol",[e("li",[s._v("每次登录成功后刷新api_token为新值\n其实 Laravel 官方提供了一个 "),e("a",{attrs:{href:"https://github.com/laravel/passport",target:"_blank",rel:"noopener noreferrer"}},[s._v("Laravel Passport"),e("OutboundLink")],1),s._v(" 的包。Laravel Passport is an OAuth2 server and API authentication package 。\n具体使用请等更新。")])]),s._v(" "),e("p",[s._v("问题：\n如何修改默认的api_token列？")])])}),[],!1,null,null,null);n.default=t.exports}}]);