(window.webpackJsonp=window.webpackJsonp||[]).push([[150],{588:function(e,s,n){"use strict";n.r(s);var a=n(30),t=Object(a.a)({},(function(){var e=this,s=e.$createElement,n=e._self._c||s;return n("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[n("p",[e._v("之前讲解了Docker镜像的分层机制，本节介绍下Docker的分层缓存机制。")]),e._v(" "),n("p",[e._v("为了加快构建速度，Docker实现了缓存：\n如果Dockerfile和相关文件未更改，则重建(rebuild)时可以重用本地镜像缓存中的某些现有层。\n但是，为了利用此缓存，您需要了解它的工作方式，这就是我们将在本文中介绍的内容。")]),e._v(" "),n("p",[e._v("我们来看一个使用以下Dockerfile的示例：")]),e._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v('FROM python:3.7-slim-buster\nCOPY . .\nRUN pip install --quiet -r requirements.txt\nENTRYPOINT ["python", "server.py"]\n')])]),e._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[e._v("1")]),n("br"),n("span",{staticClass:"line-number"},[e._v("2")]),n("br"),n("span",{staticClass:"line-number"},[e._v("3")]),n("br"),n("span",{staticClass:"line-number"},[e._v("4")]),n("br")])]),n("p",[e._v("第一次运行时，所有命令都会运行：")]),e._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v('$ docker build -t example1 .\nSending build context to Docker daemon   5.12kB\nStep 1/4 : FROM python:3.7-slim-buster\n ---\x3e f96c28b7013f\nStep 2/4 : COPY . .\n ---\x3e eff791eb839d\nStep 3/4 : RUN pip install --quiet -r requirements.txt\n ---\x3e Running in 591f97f47b6e\nRemoving intermediate container 591f97f47b6e\n ---\x3e 02c7cf5a3d9a\nStep 4/4 : ENTRYPOINT ["python", "server.py"]\n ---\x3e Running in e3cf483c3381\nRemoving intermediate container e3cf483c3381\n ---\x3e 598b0340cc90\nSuccessfully built 598b0340cc90\nSuccessfully tagged example1:latest\n')])]),e._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[e._v("1")]),n("br"),n("span",{staticClass:"line-number"},[e._v("2")]),n("br"),n("span",{staticClass:"line-number"},[e._v("3")]),n("br"),n("span",{staticClass:"line-number"},[e._v("4")]),n("br"),n("span",{staticClass:"line-number"},[e._v("5")]),n("br"),n("span",{staticClass:"line-number"},[e._v("6")]),n("br"),n("span",{staticClass:"line-number"},[e._v("7")]),n("br"),n("span",{staticClass:"line-number"},[e._v("8")]),n("br"),n("span",{staticClass:"line-number"},[e._v("9")]),n("br"),n("span",{staticClass:"line-number"},[e._v("10")]),n("br"),n("span",{staticClass:"line-number"},[e._v("11")]),n("br"),n("span",{staticClass:"line-number"},[e._v("12")]),n("br"),n("span",{staticClass:"line-number"},[e._v("13")]),n("br"),n("span",{staticClass:"line-number"},[e._v("14")]),n("br"),n("span",{staticClass:"line-number"},[e._v("15")]),n("br"),n("span",{staticClass:"line-number"},[e._v("16")]),n("br")])]),n("p",[e._v("第二次构建时，因为没有任何改变，docker构建将使用镜像缓存：")]),e._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v('$ docker build -t example1 .\nSending build context to Docker daemon   5.12kB\nStep 1/4 : FROM python:3.7-slim-buster\n ---\x3e f96c28b7013f\nStep 2/4 : COPY . .\n ---\x3e Using cache\n ---\x3e eff791eb839d\nStep 3/4 : RUN pip install --quiet -r requirements.txt\n ---\x3e Using cache\n ---\x3e 02c7cf5a3d9a\nStep 4/4 : ENTRYPOINT ["python", "server.py"]\n ---\x3e Using cache\n ---\x3e 598b0340cc90\nSuccessfully built 598b0340cc90\nSuccessfully tagged example1:latest\n')])]),e._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[e._v("1")]),n("br"),n("span",{staticClass:"line-number"},[e._v("2")]),n("br"),n("span",{staticClass:"line-number"},[e._v("3")]),n("br"),n("span",{staticClass:"line-number"},[e._v("4")]),n("br"),n("span",{staticClass:"line-number"},[e._v("5")]),n("br"),n("span",{staticClass:"line-number"},[e._v("6")]),n("br"),n("span",{staticClass:"line-number"},[e._v("7")]),n("br"),n("span",{staticClass:"line-number"},[e._v("8")]),n("br"),n("span",{staticClass:"line-number"},[e._v("9")]),n("br"),n("span",{staticClass:"line-number"},[e._v("10")]),n("br"),n("span",{staticClass:"line-number"},[e._v("11")]),n("br"),n("span",{staticClass:"line-number"},[e._v("12")]),n("br"),n("span",{staticClass:"line-number"},[e._v("13")]),n("br"),n("span",{staticClass:"line-number"},[e._v("14")]),n("br"),n("span",{staticClass:"line-number"},[e._v("15")]),n("br")])]),n("p",[e._v("请注意，上面显示的Using cache加快了构建速度(无需从网络下载任何pip依赖包)")]),e._v(" "),n("p",[e._v("如果我们删除镜像，则后续构建将从头开始(没有层缓存了)：")]),e._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v("$ docker image rm example1\nUntagged: example1:latest\nDeleted: sha256:598b0340cc90967501c5c51862dc586ca69a01ca465f48232fc457d3ab122a73\nDeleted: sha256:02c7cf5a3d9af1939b9f5286312b23898fd3ea12b7cb1d7a77251251740a806c\nDeleted: sha256:d9e9602d9c3fd7381a8e1de301dc4345be2eb2b8488b5fc3e190eaacbb2f9596\nDeleted: sha256:eff791eb839d00cbf46d139d8595b23867bc580bb9164b90253d0b2d9fcca236\nDeleted: sha256:53d34b2ead0a465d229a4260fee2a845fb8551856d4019cd2e608dfe0e039e77\n$ docker build -t example1 .\nSending build context to Docker daemon   5.12kB\nStep 1/4 : FROM python:3.7-slim-buster\n ---\x3e f96c28b7013f\nStep 2/4 : COPY . .\n ---\x3e 63c32b9b1af6\n...\n")])]),e._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[e._v("1")]),n("br"),n("span",{staticClass:"line-number"},[e._v("2")]),n("br"),n("span",{staticClass:"line-number"},[e._v("3")]),n("br"),n("span",{staticClass:"line-number"},[e._v("4")]),n("br"),n("span",{staticClass:"line-number"},[e._v("5")]),n("br"),n("span",{staticClass:"line-number"},[e._v("6")]),n("br"),n("span",{staticClass:"line-number"},[e._v("7")]),n("br"),n("span",{staticClass:"line-number"},[e._v("8")]),n("br"),n("span",{staticClass:"line-number"},[e._v("9")]),n("br"),n("span",{staticClass:"line-number"},[e._v("10")]),n("br"),n("span",{staticClass:"line-number"},[e._v("11")]),n("br"),n("span",{staticClass:"line-number"},[e._v("12")]),n("br"),n("span",{staticClass:"line-number"},[e._v("13")]),n("br"),n("span",{staticClass:"line-number"},[e._v("14")]),n("br")])]),n("p",[e._v("缓存算法还有一个更重要的规则：")]),e._v(" "),n("h4",{attrs:{id:"如果某层无法应用层缓存-则后续层都不能从层缓存加载"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#如果某层无法应用层缓存-则后续层都不能从层缓存加载"}},[e._v("#")]),e._v(" 如果某层无法应用层缓存，则后续层都不能从层缓存加载")]),e._v(" "),n("p",[e._v("在以下示例中，前后两次构建过程的C层均未更改，尽管如此，由于上层并不是从层缓存中加载，因此后置的C层仍然无法从缓存中加载：")]),e._v(" "),n("p",[n("img",{attrs:{src:"https://gitee.com/finley/upic/raw/master/uPic/2020/05/25/50-03-3cb3e531-ba7f-4705-8408-e920da6f3c38.png",alt:"50-03-3cb3e531-ba7f-4705-8408-e920da6f3c38"}})]),e._v(" "),n("p",[e._v("层缓存对下面的Dockerfile意味着什么？")]),e._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v('FROM python:3.7-slim-buster\nCOPY requirements.txt .\nCOPY server.py .\nRUN pip install --quiet -r requirements.txt\nENTRYPOINT ["python", "server.py"]\n')])]),e._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[e._v("1")]),n("br"),n("span",{staticClass:"line-number"},[e._v("2")]),n("br"),n("span",{staticClass:"line-number"},[e._v("3")]),n("br"),n("span",{staticClass:"line-number"},[e._v("4")]),n("br"),n("span",{staticClass:"line-number"},[e._v("5")]),n("br")])]),n("p",[e._v("如果COPY命令的任何文件改变了，则会使后续所有层缓存失效：我们需要重新运行pip install。\n但是，如果server.py更改了，但requirements.txt却没有更改，为什么我们必须重做pip安装？毕竟，pip安装仅使用requirements.txt。")]),e._v(" "),n("p",[e._v("推及到现代编程语言：前端的依赖包文件paakcage.json, dotnet的项目管理文件dotnetdemo.csproj等，一般很少变更；随时变动的业务代码，导致后续的层缓存失效(后续层每次都要重新下载&安装依赖)。")]),e._v(" "),n("p",[e._v("因此，您要做的是仅复制实际需要运行下一步的那些文件，以最大程度地减少缓存失效的机会。")]),e._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[e._v('FROM python:3.7-slim-buster\nCOPY requirements.txt .\nRUN pip install --quiet -r requirements.txt\nCOPY server.py .\nENTRYPOINT ["python", "server.py"]\n')])]),e._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[e._v("1")]),n("br"),n("span",{staticClass:"line-number"},[e._v("2")]),n("br"),n("span",{staticClass:"line-number"},[e._v("3")]),n("br"),n("span",{staticClass:"line-number"},[e._v("4")]),n("br"),n("span",{staticClass:"line-number"},[e._v("5")]),n("br")])]),n("p",[e._v("如果您想通过重用之前缓存的层来进行快速构建，则需要适当地编写Dockerfile：")]),e._v(" "),n("ul",[n("li",[e._v("仅复制下一步所需的文件，以最大程度地减少构建过程中的缓存失效。")]),e._v(" "),n("li",[e._v("尽量将文件可能变更的新增(ADD命令)、拷贝(COPY命令) 延迟到Dockerfile的后部。")])])])}),[],!1,null,null,null);s.default=t.exports}}]);