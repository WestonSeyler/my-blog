(window.webpackJsonp=window.webpackJsonp||[]).push([[23],{461:function(t,e,a){"use strict";a.r(e);var l=a(30),v=Object(l.a)({},(function(){var t=this,e=t.$createElement,a=t._self._c||e;return a("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[a("h2",{attrs:{id:"简介"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#简介"}},[t._v("#")]),t._v(" 简介")]),t._v(" "),a("p",[t._v("当客户端断开连接时，发送给相关的订阅者的遗嘱消息。以下情况下会发送 Will Message：")]),t._v(" "),a("ul",[a("li",[t._v("服务端发生了I/O 错误或者网络失败；")]),t._v(" "),a("li",[t._v("客户端在定义的心跳时期失联；")]),t._v(" "),a("li",[t._v("客户端在发送下线包之前关闭网络连接；")]),t._v(" "),a("li",[t._v("服务端在收到下线包之前关闭网络连接。")])]),t._v(" "),a("p",[t._v("遗嘱消息一般通过在客户端 CONNECT 的时候指定。如下所示，在连接的时候通过调用 "),a("code",[t._v("MqttConnectOptions")]),t._v(" 实例的 "),a("code",[t._v("setWill")]),t._v(" 方法来设定。任何订阅了下面的主题的客户端都可以收到该遗嘱消息。")]),t._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("//方法1MqttConnectOptions.setWill(MqttTopic topic, byte[] payload, int qos, boolean retained)//方法2MqttConnectOptions.setWill(java.lang.String topic, byte[] payload, int qos, boolean retained)\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br")])]),a("h2",{attrs:{id:"使用场景"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#使用场景"}},[t._v("#")]),t._v(" 使用场景")]),t._v(" "),a("p",[t._v("在客户端 A 进行连接时候，遗嘱消息设定为”offline“，客户端 B 订阅这个遗嘱主题。当 A 异常断开时，客户端 B 会收到这个”offline“的遗嘱消息，从而知道客户端 A 离线了。")]),t._v(" "),a("h3",{attrs:{id:"connect-flag-报文字段"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#connect-flag-报文字段"}},[t._v("#")]),t._v(" Connect Flag 报文字段")]),t._v(" "),a("table",[a("thead",[a("tr",[a("th",[t._v("Bit")]),t._v(" "),a("th",[t._v("7")]),t._v(" "),a("th",[t._v("6")]),t._v(" "),a("th",[t._v("5")]),t._v(" "),a("th",[t._v("4")]),t._v(" "),a("th",[t._v("2")]),t._v(" "),a("th",[t._v("1")]),t._v(" "),a("th",[t._v("0")])])]),t._v(" "),a("tbody",[a("tr",[a("td"),t._v(" "),a("td",[t._v("User Name Flag")]),t._v(" "),a("td",[t._v("Password Flag")]),t._v(" "),a("td",[t._v("Will Retain")]),t._v(" "),a("td",[t._v("Will QoS")]),t._v(" "),a("td",[t._v("Will Flag")]),t._v(" "),a("td",[t._v("Clean Start")]),t._v(" "),a("td",[t._v("Reserved")])]),t._v(" "),a("tr",[a("td",[t._v("byte 8")]),t._v(" "),a("td",[t._v("X")]),t._v(" "),a("td",[t._v("X")]),t._v(" "),a("td",[t._v("X")]),t._v(" "),a("td",[t._v("X")]),t._v(" "),a("td",[t._v("X")]),t._v(" "),a("td",[t._v("X")]),t._v(" "),a("td",[t._v("X")])])])]),t._v(" "),a("p",[t._v("遗嘱消息在客户端正常调用 disconnect 方法之后并不会被发送。")]),t._v(" "),a("h2",{attrs:{id:"will-flag-作用"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#will-flag-作用"}},[t._v("#")]),t._v(" Will Flag 作用")]),t._v(" "),a("p",[t._v("简而言之，就是客户端预先定义好，在自己异常断开的情况下，所留下的最后遗愿（Last Will），也称之为遗嘱（Testament）。这个遗嘱就是一个由客户端预先定义好的主题和对应消息，附加在CONNECT的可变报文头部中，在客户端连接出现异常的情况下，由服务器主动发布此消息。")]),t._v(" "),a("p",[t._v("当Will Flag位为1时，Will QoS和Will Retain才会被读取，此时消息体中要出现Will Topic和Will Message具体内容，否则Will QoS和Will Retain值会被忽略掉。")]),t._v(" "),a("p",[t._v("当Will Flag位为0时，则Will Qos和Will Retain无效。")]),t._v(" "),a("h2",{attrs:{id:"命令行示例"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#命令行示例"}},[t._v("#")]),t._v(" 命令行示例")]),t._v(" "),a("p",[t._v("下面是一个Will Message的示例：")]),t._v(" "),a("ol",[a("li",[a("p",[t._v("Sub端clientid=sub预定义遗嘱消息:")]),t._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("mosquitto_sub --will-topic test --will-payload die --will-qos 2 -t topic -i sub -h 192.168.1.1\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br")])])]),t._v(" "),a("li",[a("p",[t._v("客户端 clientid=alive 在 192.168.1.1（EMQ服务器) 订阅遗嘱主题")]),t._v(" "),a("div",{staticClass:"language- line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-text"}},[a("code",[t._v("mosquitto_sub -t test -i alive -q 2 -h 192.168.1.1\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br")])])]),t._v(" "),a("li",[a("p",[t._v("异常断开Sub端与Server端（EMQ服务器）连接，Pub端收到Will Message 。")])])]),t._v(" "),a("h2",{attrs:{id:"高级使用场景"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#高级使用场景"}},[t._v("#")]),t._v(" 高级使用场景")]),t._v(" "),a("p",[t._v("这里介绍一下如何将 Retained 消息与Will 消息结合起来进行使用。")]),t._v(" "),a("ol",[a("li",[t._v("客户端 A 遗嘱消息设定为”offline“，该遗嘱主题与一个普通发送状态的主题设定成同一个 "),a("code",[t._v("A/status")]),t._v("；")]),t._v(" "),a("li",[t._v("当客户端 A 连接时，向主题 "),a("code",[t._v("A/status")]),t._v(" 发送 “online” 的 Retained 消息，其它客户端订阅主题 "),a("code",[t._v("A/status")]),t._v("的时候，获取 Retained 消息为 “online” ；")]),t._v(" "),a("li",[t._v("当客户端 A 异常断开时，系统自动向主题 "),a("code",[t._v("A/status")]),t._v(" 发送”offline“的消息，其它订阅了此主题的客户端会马上收到”offline“消息；如果遗嘱消息被设定了 Retained 的话，这时有新的订阅"),a("code",[t._v("A/status")]),t._v("主题的客户端上线的时候，获取到的消息为“offline”。")])])])}),[],!1,null,null,null);e.default=v.exports}}]);