(window.webpackJsonp=window.webpackJsonp||[]).push([[155],{593:function(e,r,o){"use strict";o.r(r);var c=o(30),d=Object(c.a)({},(function(){var e=this,r=e.$createElement,o=e._self._c||r;return o("ContentSlotsDistributor",{attrs:{"slot-key":e.$parent.slotKey}},[o("h2",{attrs:{id:"docker-in-docker"}},[o("a",{staticClass:"header-anchor",attrs:{href:"#docker-in-docker"}},[e._v("#")]),e._v(" Docker In Docker")]),e._v(" "),o("p",[e._v("就是在docker内运行Docker\n一个常用的场景是我们用Docker起了一个Jenkins，Jenkins构建项目的时候，为了保证项目环境是干净的，\n也需要拉一个docker镜像，把项目放到干净的容器中。")]),e._v(" "),o("h2",{attrs:{id:"在docker容器中运行docker"}},[o("a",{staticClass:"header-anchor",attrs:{href:"#在docker容器中运行docker"}},[e._v("#")]),e._v(" 在Docker容器中运行Docker")]),e._v(" "),o("p",[e._v("在Docker中实现Docker的三种方法")]),e._v(" "),o("ol",[o("li",[e._v("通过挂载docker.sock（DooD方法）运行docker")]),e._v(" "),o("li",[e._v("dind 方法")]),e._v(" "),o("li",[e._v("使用Nestybox sysbox Docker运行时")])]),e._v(" "),o("h3",{attrs:{id:"方法1-使用-var-run-docker-sock-的docker中运行docker"}},[o("a",{staticClass:"header-anchor",attrs:{href:"#方法1-使用-var-run-docker-sock-的docker中运行docker"}},[e._v("#")]),e._v(" 方法1：使用[/var/run/docker.sock]的Docker中运行Docker")]),e._v(" "),o("p",[o("code",[e._v("/var/run/docker.sock")]),e._v("是默认的Unix套接字。套接字用于在同一主机上的进程之间进行通信。Docker守护程序默认情况下侦听docker.sock。\n如果您在运行Docker守护程序的主机上，则可以使用"),o("code",[e._v("/var/run/docker.sock")]),e._v("管理容器。")]),e._v(" "),o("p",[e._v("例如，如果运行以下命令，它将返回docker engine的版本。")]),e._v(" "),o("p",[o("code",[e._v("curl --unix-socket /var/run/docker.sock http://localhost/version")])]),e._v(" "),o("p",[e._v("要在docker内部运行docker，要做的只是在默认Unix套接字docker.sock作为卷的情况下运行docker。\n"),o("code",[e._v("-v /var/run/docker.sock:/var/run/docker.sock")])]),e._v(" "),o("div",{staticClass:"custom-block warning"},[o("p",{staticClass:"custom-block-title"},[e._v("WARNING")]),e._v(" "),o("p",[e._v("如果您的容器可以访问docker.sock，则意味着它具有对docker守护程序的更多特权。因此，在实际项目中使用时，请了解并使用安全隐患。")])]),e._v(" "),o("p",[e._v("现在，从容器中应该能够执行docker命令来构建镜像并将其推送到镜像仓库。\n在这里，实际的docker操作发生在运行docker容器的VM主机上，而不是在容器内部进行。\n意思是，即使您正在容器中执行docker命令，也指示Docker客户端通过以下docker.sock方式连接到VM主机docker-engine。")]),e._v(" "),o("p",[e._v("上面的意思是，假如Jenkins是运行在容器中，在Jenkins中执行docker run...，和在服务器上(就是宿主机)直接执行docker run..效果一样")]),e._v(" "),o("h3",{attrs:{id:"方法2-docker-in-docker"}},[o("a",{staticClass:"header-anchor",attrs:{href:"#方法2-docker-in-docker"}},[e._v("#")]),e._v(" 方法2：Docker In Docker")]),e._v(" "),o("p",[e._v("此方法实际上在容器内部创建一个子容器。仅当确实要在容器中包含容器和镜像时才使用此方法。\n否则，建议使用第一种方法。为此，只需要使用带有dind标签的官方docker镜像即可。")]),e._v(" "),o("p",[e._v("建立一个以docker:dind为镜像，名字为some-docker的docker容器")]),e._v(" "),o("p",[o("code",[e._v("docker run --privileged --name some-docker -v /my/own/var-lib-docker:/var/lib/docker -d docker:dind")])]),e._v(" "),o("p",[e._v("使用exec登录到容器。\n"),o("code",[e._v("docker exec -it some-docker /bin/sh")])]),e._v(" "),o("p",[e._v("登录后可以执行docker build等docker命令了")]),e._v(" "),o("div",{staticClass:"custom-block warning"},[o("p",{staticClass:"custom-block-title"},[e._v("WARNING")]),e._v(" "),o("p",[e._v("为了对主机环境的完全访问，--privileged 特权模式是必须的")])]),e._v(" "),o("h3",{attrs:{id:"方法3-使用sysbox运行时的docker中的docker"}},[o("a",{staticClass:"header-anchor",attrs:{href:"#方法3-使用sysbox运行时的docker中的docker"}},[e._v("#")]),e._v(" 方法3：使用Sysbox运行时的Docker中的Docker")]),e._v(" "),o("p",[o("a",{attrs:{href:"https://github.com/nestybox/sysbox",target:"_blank",rel:"noopener noreferrer"}},[e._v("Sysbox"),o("OutboundLink")],1),e._v(" 是nestybox公司旗下的一款产品，当允许Docker容器充当虚拟服务器，\n能够在其中运行Systemd、Docker和Kubernetes等软件，操作容易且具有适当的隔离。")]),e._v(" "),o("p",[e._v("比前两种好处是避免了访问宿主机")]),e._v(" "),o("ol",[o("li",[e._v("安装sysbox运行时环境")]),e._v(" "),o("li",[e._v("使用sysbox运行时标志启动docker容器，还使用官方的docker:dind镜像\n"),o("code",[e._v("docker run --runtime=sysbox-runc --name sysbox-dind -d docker:dind")])]),e._v(" "),o("li",[e._v("进入sysbox-dind容器\n`docker exec -it sysbox-dind /bin/sh")]),e._v(" "),o("li",[e._v("可以在里面构建docker镜像了")])]),e._v(" "),o("h2",{attrs:{id:"总结"}},[o("a",{staticClass:"header-anchor",attrs:{href:"#总结"}},[e._v("#")]),e._v(" 总结")]),e._v(" "),o("p",[e._v("使用docker.sock和dind方法在docker中运行docker的安全性较差，因为它具有对docker守护程序的完全特权")])])}),[],!1,null,null,null);r.default=d.exports}}]);