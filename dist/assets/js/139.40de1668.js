(window.webpackJsonp=window.webpackJsonp||[]).push([[139],{576:function(s,a,t){"use strict";t.r(a);var e=t(30),n=Object(e.a)({},(function(){var s=this,a=s.$createElement,t=s._self._c||a;return t("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[t("p",[s._v("Docker 的一大好处是在本地可以很方便快速的搭建负载均衡，主从同步等需要多主机的环境。\n可以说是极大方便了运维成本和难度。\n本节在本地搭建 mysql 的一主一从的集群环境。")]),s._v(" "),t("p",[s._v("关于主从同步的流程图，放张网上找的流程图")]),s._v(" "),t("blockquote",[t("p",[t("img",{attrs:{src:"https://hexo-blog.pek3b.qingstor.com/upload_images/71414-9bd1d2570613f8de.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240",alt:"image.png"}})])]),s._v(" "),t("p",[s._v("以mysql5.7为例")]),s._v(" "),t("ol",[t("li",[s._v("创建 mysql-master-slave 目录，比如完整路径是\nD:/docker/mysql-master-slave\n目录结构如下：")])]),s._v(" "),t("div",{staticClass:"language-yaml line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-yaml"}},[t("code",[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" master\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" data\n   mysqld.cnf\n"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" slave\n  "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("-")]),s._v(" data\n      mysqld.cnf\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br")])]),t("ol",{attrs:{start:"2"}},[t("li",[s._v("其中master目录底下的 mysqld.cnf 配置文件内容为")])]),s._v(" "),t("div",{staticClass:"language-ini line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-ini"}},[t("code",[t("span",{pre:!0,attrs:{class:"token header"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token section-name selector"}},[s._v("mysqld")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")])]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("pid-file")]),s._v("\t"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("/var/run/mysqld/mysqld.pid")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("socket")]),s._v("\t\t"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("/var/run/mysqld/mysqld.sock")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("datadir")]),s._v("\t\t"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("/var/lib/mysql")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#log-error\t= /var/log/mysql/error.log")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# By default we only accept connections from localhost")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#bind-address\t= 127.0.0.1")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# Disabling symbolic-links is recommended to prevent assorted security risks")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("symbolic-links")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("0")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 以下是新增内容")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 标识不同的数据库服务器，而且唯一")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("server-id")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("1")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 启用二进制日志")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("log-bin")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("mysql-bin")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("log-slave-updates")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("1")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("innodb_flush_log_at_trx_commit")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("2")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("innodb_flush_method")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("O_DIRECT")]),s._v("\nskip-host-cache\nskip-name-resolve\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br"),t("span",{staticClass:"line-number"},[s._v("21")]),t("br"),t("span",{staticClass:"line-number"},[s._v("22")]),t("br"),t("span",{staticClass:"line-number"},[s._v("23")]),t("br")])]),t("p",[s._v("slave 目录底下的 mysqld.cnf 内容为")]),s._v(" "),t("div",{staticClass:"language-ini line-numbers-mode"},[t("pre",{pre:!0,attrs:{class:"language-ini"}},[t("code",[t("span",{pre:!0,attrs:{class:"token header"}},[t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("[")]),t("span",{pre:!0,attrs:{class:"token section-name selector"}},[s._v("mysqld")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("]")])]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("pid-file")]),s._v("\t        "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("/var/run/mysqld/mysqld.pid")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("socket")]),s._v("\t\t"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("/var/run/mysqld/mysqld.sock")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("datadir")]),s._v("\t\t"),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("/var/lib/mysql")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#log-error\t= /var/log/mysql/error.log")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# By default we only accept connections from localhost")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("#bind-address\t= 127.0.0.1")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# Disabling symbolic-links is recommended to prevent assorted security risks")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("symbolic-links")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("0")]),s._v("\n\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 以下是新增内容")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("server-id")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("2")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("log-bin")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("mysql-bin")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("log-slave-updates")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("1")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token comment"}},[s._v("# 多主的话需要注意这个配置，防止自增序列冲突。")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("auto_increment_increment")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("2")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("auto_increment_offset")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("2")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("read-only")]),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("1")]),s._v("\n"),t("span",{pre:!0,attrs:{class:"token key attr-name"}},[s._v("slave-skip-errors")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token punctuation"}},[s._v("=")]),s._v(" "),t("span",{pre:!0,attrs:{class:"token value attr-value"}},[s._v("1062")]),s._v("\nskip-host-cache\nskip-name-resolve\n")])]),s._v(" "),t("div",{staticClass:"line-numbers-wrapper"},[t("span",{staticClass:"line-number"},[s._v("1")]),t("br"),t("span",{staticClass:"line-number"},[s._v("2")]),t("br"),t("span",{staticClass:"line-number"},[s._v("3")]),t("br"),t("span",{staticClass:"line-number"},[s._v("4")]),t("br"),t("span",{staticClass:"line-number"},[s._v("5")]),t("br"),t("span",{staticClass:"line-number"},[s._v("6")]),t("br"),t("span",{staticClass:"line-number"},[s._v("7")]),t("br"),t("span",{staticClass:"line-number"},[s._v("8")]),t("br"),t("span",{staticClass:"line-number"},[s._v("9")]),t("br"),t("span",{staticClass:"line-number"},[s._v("10")]),t("br"),t("span",{staticClass:"line-number"},[s._v("11")]),t("br"),t("span",{staticClass:"line-number"},[s._v("12")]),t("br"),t("span",{staticClass:"line-number"},[s._v("13")]),t("br"),t("span",{staticClass:"line-number"},[s._v("14")]),t("br"),t("span",{staticClass:"line-number"},[s._v("15")]),t("br"),t("span",{staticClass:"line-number"},[s._v("16")]),t("br"),t("span",{staticClass:"line-number"},[s._v("17")]),t("br"),t("span",{staticClass:"line-number"},[s._v("18")]),t("br"),t("span",{staticClass:"line-number"},[s._v("19")]),t("br"),t("span",{staticClass:"line-number"},[s._v("20")]),t("br"),t("span",{staticClass:"line-number"},[s._v("21")]),t("br")])]),t("ol",{attrs:{start:"3"}},[t("li",[s._v("基于官方mysql镜像，运行两个容器并指定一些参数\n启动 名称为mysql_master的容器作为master数据库")])]),s._v(" "),t("p",[t("code",[s._v("docker run --name mysql_master -d -p 3307:3306 -e MYSQL_ROOT_PASSWORD=123456 -v D:/docker/mysql-master-slave/master/data:/var/lib/mysql -v D:/docker/mysql-master-slave/master/mysqld.cnf:/etc/mysql/mysql.conf.d/mysqld.cnf mysql:5.7")])]),s._v(" "),t("p",[t("code",[s._v("docker run --name mysql_slave -d -p 3308:3306 -e MYSQL_ROOT_PASSWORD=123456 -v D:/docker/mysql-master-slave/slave/data:/var/lib/mysql -v D:/docker/mysql-master-slave/slave/mysqld.cnf:/etc/mysql/mysql.conf.d/mysqld.cnf mysql:5.7")])]),s._v(" "),t("p",[s._v("这个时候宿主机的 Navicat 应该可以连上容器里的两个数据库了。")]),s._v(" "),t("ol",{attrs:{start:"4"}},[t("li",[s._v("配置主从同步，新开终端进入容器\n"),t("code",[s._v("docker exec -it mysql_master bash")]),s._v(" "),t("code",[s._v("mysql -u root -p")]),s._v("\n创建一个同步数据权限的用户\n"),t("code",[s._v("GRANT REPLICATION SLAVE ON *.* to 'backup'@'%' identified by '123456';")]),s._v("\n查看状态，记住File、Position的值，在 Slave 中将用到\n"),t("code",[s._v("show master status;")])])]),s._v(" "),t("blockquote",[t("p",[t("img",{attrs:{src:"https://hexo-blog.pek3b.qingstor.com/upload_images/71414-b1ffc7e43d23e527.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240",alt:"image.png"}})])]),s._v(" "),t("p",[s._v("进入slave容器\n"),t("code",[s._v("docker exec -it mysql_slave bash")]),s._v(" "),t("code",[s._v("mysql -u root -p")]),s._v("\n设置主库链接\n"),t("code",[s._v("change master to master_host='172.17.0.2',master_user='backup',master_password='123456',master_log_file='mysql-bin.000001',master_log_pos=0,master_port=3306;")]),s._v("\n启动从库同步\n"),t("code",[s._v("start slave")]),s._v("\n查看状态，如果 Slave_SQL_Running_State 是 Slave has read all relay log; waiting for more updates 表示正常运行。\n"),t("code",[s._v("show slave status \\G")])]),s._v(" "),t("blockquote",[t("p",[t("img",{attrs:{src:"https://hexo-blog.pek3b.qingstor.com/upload_images/71414-bb110847401decb9.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240",alt:"image.png"}})])]),s._v(" "),t("ol",{attrs:{start:"5"}},[t("li",[s._v("测试同步，在master上新建一个数据库\n"),t("code",[s._v('docker exec mysql_master mysql -uroot -p123456 -e "CREATE DATABASE test"')]),s._v(" "),t("code",[s._v('docker exec mysql_slave mysql -uroot -p123456 -e "SHOW DATABASES"')])])]),s._v(" "),t("h3",{attrs:{id:"总结"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#总结"}},[s._v("#")]),s._v(" 总结：")]),s._v(" "),t("ol",[t("li",[t("p",[s._v("mysqld.cnf 文件的由来?\n答：就是从容器内的 "),t("code",[s._v("/etc/mysql/mysql.conf.d/mysqld.cnf")]),s._v(" 拷贝出来的")])]),s._v(" "),t("li",[t("p",[s._v("主从同步的简单原理？\n答：\nMySQL的主从复制是一个异步的复制过程，数据库从一个Master复制到Slave数据库，在Master与Slave之间实现整个主从复制的过程是由三个线程参与完成的，其中有两个线程(SQL线程和IO线程)在Slave端，另一个线程(IO线程)在Master端。\nmaster 数据变化时会产生bin log日志，slave上的线程拉去bin log，然后在slave上重新执行日志。这样就保证了数据一致性。")])]),s._v(" "),t("li",[t("p",[s._v("show slave status 中的Slave_IO_Running和Slave_SQL_Running的含义？\n答：Slave 上会同时有两个线程在工作， I/O 线程从 Master 得到数据（Binary Log 文件），放到被称为\nRelay Log 文件中进行记录。另一方面，SQL 线程则将 Relay Log 读取并执行。\n为什么要有两个线程？这是为了降低同步的延迟。因为 I/O 线程和 SQL 线程都是相对很耗时的操作。")])]),s._v(" "),t("li",[t("p",[s._v("从服务器同步失败？\n答：看错误日志 "),t("code",[s._v("tail /var/log/mysql/error.log")]),s._v("\n重新执行同步\n"),t("code",[s._v("stop slave;")]),s._v(" "),t("code",[s._v("change master to master_log_file='mysql-bin.000100,master_log_pos=123'")]),s._v("\n关于 file 和 pos，需在master上执行"),t("code",[s._v("show master status")]),s._v("获得。\n或者使用 "),t("code",[s._v("mysqlbinlog")]),s._v(" 命令分析。")])]),s._v(" "),t("li",[t("p",[s._v("如何添加多个从节点?\n和添加第一个从节点类似，先导出master的数据，复制第一个slave配置文件，唯一要改变的是server-id，不能和其他的重复。之后启动新的容器，进到容器内执行"),t("code",[s._v("change master to ...")]),s._v("。\n还需要注意当前master没有写入等操作，最好先锁表，同步设置好后在解锁。"),t("a",{attrs:{href:"https://blog.csdn.net/zhengwei125/article/details/50071041",target:"_blank",rel:"noopener noreferrer"}},[s._v("参考"),t("OutboundLink")],1)])])]),s._v(" "),t("h3",{attrs:{id:"问题"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#问题"}},[s._v("#")]),s._v(" 问题：")]),s._v(" "),t("ol",[t("li",[s._v("如何添加slave节点服务器，如何主主备份\n更多细节还得啃官方"),t("a",{attrs:{href:"https://dev.mysql.com/doc/refman/5.7/en/replication.html",target:"_blank",rel:"noopener noreferrer"}},[s._v("文档"),t("OutboundLink")],1)]),s._v(" "),t("li",[s._v("使用 docker compose 配置 mysql 主从 http://tarunlalwani.com/post/mysql-master-slave-using-docker/")])]),s._v(" "),t("h3",{attrs:{id:"参考"}},[t("a",{staticClass:"header-anchor",attrs:{href:"#参考"}},[s._v("#")]),s._v(" 参考：")]),s._v(" "),t("ul",[t("li",[s._v("https://www.cnblogs.com/w2206/p/6963065.html")]),s._v(" "),t("li",[s._v("https://github.com/Junnplus/blog/issues/1")])])])}),[],!1,null,null,null);a.default=n.exports}}]);