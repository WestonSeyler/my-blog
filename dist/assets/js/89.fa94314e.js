(window.webpackJsonp=window.webpackJsonp||[]).push([[89],{527:function(s,n,e){"use strict";e.r(n);var t=e(30),a=Object(t.a)({},(function(){var s=this,n=s.$createElement,e=s._self._c||n;return e("ContentSlotsDistributor",{attrs:{"slot-key":s.$parent.slotKey}},[e("p",[s._v("实现基于user，role，permission三表的权限管理\n因为一个用户可能拥有多种role，而一种role能同时被多个用户拥有。所以要建立多对多关系。\n"),e("a",{attrs:{href:"https://d.laravel-china.org/docs/5.5/eloquent-relationships#%E5%A4%9A%E5%AF%B9%E5%A4%9A",target:"_blank",rel:"noopener noreferrer"}},[s._v("参见文档"),e("OutboundLink")],1)]),s._v(" "),e("ol",[e("li",[s._v("建立这三个表及关联表")])]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("    public function up()\n    {\n        Schema::create('roles', function (Blueprint $table) {\n            $table->increments('id');\n            $table->string('name');\n            $table->string('label')->nullable();\n            $table->timestamps();\n        });\n\n\t    Schema::create('permissions', function (Blueprint $table) {\n\t\t    $table->increments('id');\n\t\t    $table->string('name');\n\t\t    $table->string('label')->nullable();\n\t\t    $table->timestamps();\n\t    });\n\n\t    Schema::create('permission_role', function (Blueprint $table) {\n\t\t    $table->integer('permission_id')->unsigned();\n\t\t    $table->integer('role_id')->unsigned();\n\n\t\t    $table->foreign('permission_id')\n\t\t          ->references('id')\n\t\t          ->on('permissions')\n\t\t          ->onDelete('cascade');\n\n\t\t    $table->foreign('role_id')\n\t\t          ->references('id')\n\t\t          ->on('roles')\n\t\t          ->onDelete('cascade');\n\n\t\t    $table->primary(['permission_id', 'role_id']);\n\t    });\n\n\t    Schema::create('role_user', function (Blueprint $table) {\n\t\t    $table->integer('role_id')->unsigned();\n\t\t    $table->integer('user_id')->unsigned();\n\n\t\t    $table->foreign('user_id')\n\t\t          ->references('id')\n\t\t          ->on('users')\n\t\t          ->onDelete('cascade');\n\n\t\t    $table->foreign('role_id')\n\t\t          ->references('id')\n\t\t          ->on('roles')\n\t\t          ->onDelete('cascade');\n\n\t\t    $table->primary(['user_id', 'role_id']);\n\t    });\n    }\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br"),e("span",{staticClass:"line-number"},[s._v("17")]),e("br"),e("span",{staticClass:"line-number"},[s._v("18")]),e("br"),e("span",{staticClass:"line-number"},[s._v("19")]),e("br"),e("span",{staticClass:"line-number"},[s._v("20")]),e("br"),e("span",{staticClass:"line-number"},[s._v("21")]),e("br"),e("span",{staticClass:"line-number"},[s._v("22")]),e("br"),e("span",{staticClass:"line-number"},[s._v("23")]),e("br"),e("span",{staticClass:"line-number"},[s._v("24")]),e("br"),e("span",{staticClass:"line-number"},[s._v("25")]),e("br"),e("span",{staticClass:"line-number"},[s._v("26")]),e("br"),e("span",{staticClass:"line-number"},[s._v("27")]),e("br"),e("span",{staticClass:"line-number"},[s._v("28")]),e("br"),e("span",{staticClass:"line-number"},[s._v("29")]),e("br"),e("span",{staticClass:"line-number"},[s._v("30")]),e("br"),e("span",{staticClass:"line-number"},[s._v("31")]),e("br"),e("span",{staticClass:"line-number"},[s._v("32")]),e("br"),e("span",{staticClass:"line-number"},[s._v("33")]),e("br"),e("span",{staticClass:"line-number"},[s._v("34")]),e("br"),e("span",{staticClass:"line-number"},[s._v("35")]),e("br"),e("span",{staticClass:"line-number"},[s._v("36")]),e("br"),e("span",{staticClass:"line-number"},[s._v("37")]),e("br"),e("span",{staticClass:"line-number"},[s._v("38")]),e("br"),e("span",{staticClass:"line-number"},[s._v("39")]),e("br"),e("span",{staticClass:"line-number"},[s._v("40")]),e("br"),e("span",{staticClass:"line-number"},[s._v("41")]),e("br"),e("span",{staticClass:"line-number"},[s._v("42")]),e("br"),e("span",{staticClass:"line-number"},[s._v("43")]),e("br"),e("span",{staticClass:"line-number"},[s._v("44")]),e("br"),e("span",{staticClass:"line-number"},[s._v("45")]),e("br"),e("span",{staticClass:"line-number"},[s._v("46")]),e("br"),e("span",{staticClass:"line-number"},[s._v("47")]),e("br"),e("span",{staticClass:"line-number"},[s._v("48")]),e("br"),e("span",{staticClass:"line-number"},[s._v("49")]),e("br"),e("span",{staticClass:"line-number"},[s._v("50")]),e("br")])]),e("ol",{attrs:{start:"2"}},[e("li",[s._v("建立模型关联")])]),s._v(" "),e("p",[s._v("User模型")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("...\n\tpublic function roles()\n\t{\n\t\treturn $this->belongsToMany(Role::class);\n\t}\n...\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br")])]),e("p",[s._v("Role模型")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("class Role extends Model\n{\n\tpublic function permissions()\n\t{\n\t\treturn $this->belongsToMany(Permission::class);\n\t}\n\n    // $role = Role::first(); $p = Permission::first();  \n    // $role->givePermission($p);\n\tpublic function givePermission(Permission $permission)\n\t{\n\t\treturn $this->permissions()->save($permission);\n\t}\n}\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br")])]),e("p",[s._v("Permission模型")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("class Permission extends Model\n{\n\tpublic function roles()\n\t{\n\t\treturn $this->belongsToMany(Role::class);\n\t}\n}\n\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br")])]),e("ol",{attrs:{start:"3"}},[e("li",[s._v("添加记录，这里我们添加一个admin的role和名为edit_form的permission，并且让admin拥有edit_form权限。\n"),e("img",{attrs:{src:"https://hexo-blog.pek3b.qingstor.com/upload_images/71414-d5bf911740335823.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240",alt:"image.png"}})])]),s._v(" "),e("p",[s._v("执行完 $role->givePermission($permission);会发现permission_role表多了一条记录")]),s._v(" "),e("p",[e("img",{attrs:{src:"https://hexo-blog.pek3b.qingstor.com/upload_images/71414-7155bfcd3593a6b7.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240",alt:"image.png"}})]),s._v(" "),e("p",[s._v("添加role和user的关系，将id为1的用户角色修改为admin。\n"),e("img",{attrs:{src:"https://hexo-blog.pek3b.qingstor.com/upload_images/71414-d3c1e183e6939926.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240",alt:"image.png"}})]),s._v(" "),e("p",[s._v("会发现role_user表多了一条记录\n"),e("img",{attrs:{src:"https://hexo-blog.pek3b.qingstor.com/upload_images/71414-0839d6b4e4e155e0.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240",alt:"image.png"}})]),s._v(" "),e("blockquote",[e("p",[e("code",[s._v("$user->roles()->detach($role);")]),s._v(" 可以删除这条记录\n"),e("code",[s._v("$user->roles()->attach($role);")]),s._v(" 新增记录")])]),s._v(" "),e("ol",{attrs:{start:"4"}},[e("li",[s._v("修改AuthServiceProvider.php，从数据库从读取所有的permission信息并设置Gate。让配置生效。")])]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("    public function boot()\n    {\n        $this->registerPolicies();\n\n        // Gates 接受一个用户实例作为第一个参数，并且可以接受可选参数，比如 相关的 Eloquent 模型：\n\t    foreach($this->getPermission() as $permission) {\n\t    \t// dd($permission->roles);\n\t    \tGate::define($permission->name, function($user) use ($permission) {\n\t    \t\t// 返回collection\n\t    \t\treturn $user->hasRole($permission->roles);\n\t\t    });\n\t    }\n\n    }\n\n\tpublic function getPermission()\n\t{\n\t\treturn Permission::with('roles')->get();\n    }\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br"),e("span",{staticClass:"line-number"},[s._v("10")]),e("br"),e("span",{staticClass:"line-number"},[s._v("11")]),e("br"),e("span",{staticClass:"line-number"},[s._v("12")]),e("br"),e("span",{staticClass:"line-number"},[s._v("13")]),e("br"),e("span",{staticClass:"line-number"},[s._v("14")]),e("br"),e("span",{staticClass:"line-number"},[s._v("15")]),e("br"),e("span",{staticClass:"line-number"},[s._v("16")]),e("br"),e("span",{staticClass:"line-number"},[s._v("17")]),e("br"),e("span",{staticClass:"line-number"},[s._v("18")]),e("br"),e("span",{staticClass:"line-number"},[s._v("19")]),e("br")])]),e("p",[s._v("给User模型添加hasRole方法")]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("\tpublic function hasRole($role)\n\t{\n\t\tif (is_string($role)) {\n\t\t\treturn $this->roles->contains('name', $role);\n\t\t}\n\n\t\t// intersect 移除任何指定 数组 或集合内所没有的数值。最终集合保存着原集合的键：\n\t\treturn !!$role->intersect($this->roles)->count();\n\t}\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br"),e("span",{staticClass:"line-number"},[s._v("4")]),e("br"),e("span",{staticClass:"line-number"},[s._v("5")]),e("br"),e("span",{staticClass:"line-number"},[s._v("6")]),e("br"),e("span",{staticClass:"line-number"},[s._v("7")]),e("br"),e("span",{staticClass:"line-number"},[s._v("8")]),e("br"),e("span",{staticClass:"line-number"},[s._v("9")]),e("br")])]),e("ol",{attrs:{start:"5"}},[e("li",[s._v("修改视图，测试，如果当前登录用户的id是1，就可以看到'编辑'链接")])]),s._v(" "),e("div",{staticClass:"language- line-numbers-mode"},[e("pre",{pre:!0,attrs:{class:"language-text"}},[e("code",[s._v("@can('edit_form')\n<a href=\"#\">编辑</a>\n@endcan\n")])]),s._v(" "),e("div",{staticClass:"line-numbers-wrapper"},[e("span",{staticClass:"line-number"},[s._v("1")]),e("br"),e("span",{staticClass:"line-number"},[s._v("2")]),e("br"),e("span",{staticClass:"line-number"},[s._v("3")]),e("br")])]),e("ol",{attrs:{start:"6"}},[e("li",[s._v("总结")])]),s._v(" "),e("p",[s._v("$this->roles() 与 $this->roles 有什么不同，什么情况下使用呢？\n$this->roles() 返回 QueryBuilder ，$this->roles 返回一个 Collection")])])}),[],!1,null,null,null);n.default=a.exports}}]);