(window.webpackJsonp=window.webpackJsonp||[]).push([[193],{631:function(t,s,a){"use strict";a.r(s);var n=a(30),e=Object(n.a)({},(function(){var t=this,s=t.$createElement,a=t._self._c||s;return a("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[a("p",[t._v("需求：需要把Jenkins的构建情况通过邮件，钉钉，Slack等通知告诉相关的测试，开发人员。\n结合之前讲的 "),a("a",{attrs:{href:"%5Bhttps://www.jianshu.com/p/909cd0ce98d8%5D(https://www.jianshu.com/p/909cd0ce98d8)"}},[t._v("post钩子")]),t._v(" 更进一步可以实现失败时只通知给开发人员，成功通知给所有人员等。")]),t._v(" "),a("h3",{attrs:{id:"邮件通知"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#邮件通知"}},[t._v("#")]),t._v(" 邮件通知")]),t._v(" "),a("p",[t._v("这个需要在Jenkins中配置发件人的信息，如SMTP服务器，默认的邮件内容等\n来到Jenkins的Configure System")]),t._v(" "),a("ol",[a("li",[t._v("首先在配置页面搜索 Location 配置Jenkins管理员的邮箱")])]),t._v(" "),a("blockquote",[a("p",[a("img",{attrs:{src:"https://hexo-blog.pek3b.qingstor.com/upload_images/71414-3f2e6a645cc2a99c.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240",alt:"image.png"}})])]),t._v(" "),a("ol",{attrs:{start:"2"}},[a("li",[t._v("搜索'E-mail Notification'")])]),t._v(" "),a("p",[t._v("可能会发现有两个E-mail Notification，一个是"),a("code",[t._v("Extended E-mail Notification")]),t._v("另一个是"),a("code",[t._v("E-mail Notification")]),t._v("。前者是安装Jenkins时顺便安装的插件，后者是自带的。")]),t._v(" "),a("p",[t._v("自带的E-mail Notification功能较弱，我们配置 Extended E-mail Notification，配置项比较多，不同的点问号图标。")]),t._v(" "),a("blockquote",[a("p",[a("img",{attrs:{src:"https://hexo-blog.pek3b.qingstor.com/upload_images/71414-15374369d68c3237.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240",alt:"image.png"}})])]),t._v(" "),a("ol",{attrs:{start:"3"}},[a("li",[t._v("来到Pipeline项目的配置页面，\n通过点击 Pipeline Syntax 来到 Snippet Generator， 生成pipeline脚本。\nStep 选择 mailtext: Extended Email。")])]),t._v(" "),a("blockquote",[a("p",[a("img",{attrs:{src:"https://hexo-blog.pek3b.qingstor.com/upload_images/71414-cd2e596c076a09a7.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240",alt:"image.png"}})])]),t._v(" "),a("p",[t._v("修改pipeline，添加发送邮件的步骤，放到pipeline的post部分的always块内，你也可以改为failure")]),t._v(" "),a("div",{staticClass:"language-groovy line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-groovy"}},[a("code",[t._v("    post "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n      always "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        emailext to"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'mafeifan@qq.com'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" subject"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string gstring"}},[t._v('"Job ['),a("span",{pre:!0,attrs:{class:"token expression"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("$")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("env"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("JOB_NAME"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")])]),t._v("] - Status: "),a("span",{pre:!0,attrs:{class:"token expression"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("$")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("currentBuild"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("result"),a("span",{pre:!0,attrs:{class:"token operator"}},[t._v("?:")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string"}},[t._v("'success'")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")])]),t._v('"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" body"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" \n"),a("span",{pre:!0,attrs:{class:"token string gstring"}},[t._v('"""\n<p>EXECUTED: Job <b>\\\' '),a("span",{pre:!0,attrs:{class:"token expression"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("$")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("env"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("JOB_NAME"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")])]),t._v("："),a("span",{pre:!0,attrs:{class:"token expression"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("$")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("env"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("BUILD_NUMBER"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")])]),t._v('\\\'\n</b></p><p>View console output at "<a href= "'),a("span",{pre:!0,attrs:{class:"token expression"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("$")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("env"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("BUILD_URL"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")])]),t._v('">\n'),a("span",{pre:!0,attrs:{class:"token expression"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("$")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("env"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("JOB_NAME"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")])]),t._v("："),a("span",{pre:!0,attrs:{class:"token expression"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("$")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("env"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("BUILD_NUMBER"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")])]),t._v('</a>"</p>\n<p><i>(Build log is attached.)</i></p>\n"""')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" attachLog"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("true")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" compressLog"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("true")]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br"),a("span",{staticClass:"line-number"},[t._v("5")]),a("br"),a("span",{staticClass:"line-number"},[t._v("6")]),a("br"),a("span",{staticClass:"line-number"},[t._v("7")]),a("br"),a("span",{staticClass:"line-number"},[t._v("8")]),a("br"),a("span",{staticClass:"line-number"},[t._v("9")]),a("br"),a("span",{staticClass:"line-number"},[t._v("10")]),a("br")])]),a("p",[t._v("效果如下：")]),t._v(" "),a("blockquote",[a("p",[a("img",{attrs:{src:"https://hexo-blog.pek3b.qingstor.com/upload_images/71414-bc6e26e081f58b82.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240",alt:"image.png"}})])]),t._v(" "),a("p",[t._v("关于一些参数")]),t._v(" "),a("ul",[a("li",[t._v("attachLog(可选)：将构建日志以附件形式发送")]),t._v(" "),a("li",[t._v("compressLog(可选)：压缩日志")]),t._v(" "),a("li",[t._v("recipientProviders(可选): List 类型，收件人列表类型")]),t._v(" "),a("li",[t._v("replyTo(可选)：回复邮箱")]),t._v(" "),a("li",[t._v("recipientProviders (可选)：收件人列表类型")])]),t._v(" "),a("table",[a("thead",[a("tr",[a("th",[t._v("类型名称")]),t._v(" "),a("th",[t._v("helper方法名")]),t._v(" "),a("th",[t._v("描述")])])]),t._v(" "),a("tbody",[a("tr",[a("td",[t._v("Culprits")]),t._v(" "),a("td",[t._v("culprits()")]),t._v(" "),a("td",[t._v("引发构建失败的人。最后一次构建成功和最后一次构建失败之间的变更提交者列表")])]),t._v(" "),a("tr",[a("td",[t._v("Developers")]),t._v(" "),a("td",[t._v("developers()")]),t._v(" "),a("td",[t._v("此次构建所涉及的变更的所有提交者列表")])]),t._v(" "),a("tr",[a("td",[t._v("Requestor")]),t._v(" "),a("td",[t._v("requestor()")]),t._v(" "),a("td",[t._v("请求构建的人，一般指手动触发构建的人")])]),t._v(" "),a("tr",[a("td",[t._v("Upstream Committers")]),t._v(" "),a("td",[t._v("upstreamDevelopers()")]),t._v(" "),a("td",[t._v("上游job变更提交者的列表")])])])]),t._v(" "),a("p",[t._v("更多参数见"),a("a",{attrs:{href:"https://jenkins.io/doc/pipeline/steps/email-ext/",target:"_blank",rel:"noopener noreferrer"}},[t._v("文档"),a("OutboundLink")],1)]),t._v(" "),a("h3",{attrs:{id:"slack-通知"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#slack-通知"}},[t._v("#")]),t._v(" Slack 通知")]),t._v(" "),a("p",[t._v("Slack 号称邮件杀手，是一款国外很火的消息聚合平台服务，通过建立不同的频道降低团队沟通的干扰。")]),t._v(" "),a("ol",[a("li",[a("p",[t._v("Jenkins 安装 [Slack Notification Plugin]("),a("a",{attrs:{href:"https://plugins.jenkins.io/slack",target:"_blank",rel:"noopener noreferrer"}},[t._v("https://plugins.jenkins.io/slack"),a("OutboundLink")],1)])]),t._v(" "),a("li",[a("p",[t._v("打开[插件Github官网]("),a("a",{attrs:{href:"https://github.com/jenkinsci/slack-plugin",target:"_blank",rel:"noopener noreferrer"}},[t._v("https://github.com/jenkinsci/slack-plugin"),a("OutboundLink")],1),t._v("\n根据提示没有账号的话先申请账号")])]),t._v(" "),a("li",[a("p",[t._v("Slack 端集成Jenkin CI，首先，网页端登录slack，进到自己的workspace，然后添加Jenkins应用，需要选择一个要推送通知的频道")])])]),t._v(" "),a("blockquote",[a("p",[a("img",{attrs:{src:"https://hexo-blog.pek3b.qingstor.com/upload_images/71414-a5ee5d7ea2cb6a3f.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240",alt:"image.png"}})])]),t._v(" "),a("ol",{attrs:{start:"4"}},[a("li",[t._v("根据指引配置就可以了，非常人性，下图在FreeStyle类型的项目中可配")])]),t._v(" "),a("blockquote",[a("p",[a("img",{attrs:{src:"https://hexo-blog.pek3b.qingstor.com/upload_images/71414-b7f463bfb9da4cb9.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240",alt:"image.png"}})])]),t._v(" "),a("blockquote",[a("p",[a("img",{attrs:{src:"https://hexo-blog.pek3b.qingstor.com/upload_images/71414-88657094ea253303.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240",alt:"image.png"}})])]),t._v(" "),a("ol",{attrs:{start:"5"}},[a("li",[t._v("如果需要通过Pipeline代码触发")])]),t._v(" "),a("div",{staticClass:"language-groovy line-numbers-mode"},[a("pre",{pre:!0,attrs:{class:"language-groovy"}},[a("code",[t._v("post "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n  always "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    slackSend channel"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string gstring"}},[t._v('"#机器人"')]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" message"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),a("span",{pre:!0,attrs:{class:"token string gstring"}},[t._v('"Build Started: '),a("span",{pre:!0,attrs:{class:"token expression"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("$")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("env"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("JOB_NAME"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")])]),t._v(" "),a("span",{pre:!0,attrs:{class:"token expression"}},[a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("$")]),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("env"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("BUILD_NUMBER"),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")])]),t._v('"')]),t._v("\n  "),a("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),a("div",{staticClass:"line-numbers-wrapper"},[a("span",{staticClass:"line-number"},[t._v("1")]),a("br"),a("span",{staticClass:"line-number"},[t._v("2")]),a("br"),a("span",{staticClass:"line-number"},[t._v("3")]),a("br"),a("span",{staticClass:"line-number"},[t._v("4")]),a("br")])]),a("p",[t._v("更多参数还是参见非常好用的Pipeline Syntax 的 Snippet Generator")]),t._v(" "),a("blockquote",[a("p",[a("img",{attrs:{src:"https://hexo-blog.pek3b.qingstor.com/upload_images/71414-8c634186b527adc4.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240",alt:"image.png"}})])]),t._v(" "),a("p",[t._v("效果：")]),t._v(" "),a("blockquote",[a("p",[a("img",{attrs:{src:"https://hexo-blog.pek3b.qingstor.com/upload_images/71414-2a055f985f9cf673.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240",alt:"image.png"}})])]),t._v(" "),a("h3",{attrs:{id:"钉钉通知"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#钉钉通知"}},[t._v("#")]),t._v(" 钉钉通知")]),t._v(" "),a("p",[t._v("Slack 有时候国内速度访问比较慢，如果公司喜欢用钉钉，也可以集成钉钉通知。\n步骤是类似的，不再赘述，见"),a("a",{attrs:{href:"%5Bhttps://github.com/jenkinsci/dingding-notifications-plugin/blob/master/readme-cn.md%5D(https://github.com/jenkinsci/dingding-notifications-plugin/blob/master/readme-cn.md)"}},[t._v("文档")])]),t._v(" "),a("h3",{attrs:{id:"问题"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#问题"}},[t._v("#")]),t._v(" 问题")]),t._v(" "),a("p",[t._v("使用邮件，想把构建日志作为邮件内容发送出去，但是使用 "),a("code",[t._v("${env.BUILD_LOG}")]),t._v(" 返回 null，可以改为"),a("code",[t._v("\\${BUILD_LOG}")]),t._v(" groovy 会展开所有的变量，然后留给email ext 处理这个变量\n网上也有人问了类似的"),a("a",{attrs:{href:"https://stackoverflow.com/questions/48081510/cant-access-build-log-in-jenkins-pipeline",target:"_blank",rel:"noopener noreferrer"}},[t._v("问题"),a("OutboundLink")],1),t._v("，可以使用 "),a("code",[t._v("currentBuild.rawBuild.getLog(15)")]),t._v(" 获取最后的15行日志，不过需要在 scriptApproval 页面批准下 "),a("code",[t._v("method org.jenkinsci.plugins.workflow.support.steps.build.RunWrapper getRawBuild")])]),t._v(" "),a("blockquote",[a("p",[a("img",{attrs:{src:"https://hexo-blog.pek3b.qingstor.com/upload_images/71414-e3d683b62140b2fc.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240",alt:"image.png"}})])]),t._v(" "),a("h3",{attrs:{id:"参考"}},[a("a",{staticClass:"header-anchor",attrs:{href:"#参考"}},[t._v("#")]),t._v(" 参考")]),t._v(" "),a("ul",[a("li",[a("a",{attrs:{href:"https://jenkins.io/doc/pipeline/steps/email-ext/",target:"_blank",rel:"noopener noreferrer"}},[t._v("https://jenkins.io/doc/pipeline/steps/email-ext/"),a("OutboundLink")],1)]),t._v(" "),a("li",[a("a",{attrs:{href:"https://www.cnblogs.com/yangxia-test/p/4366172.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("https://www.cnblogs.com/yangxia-test/p/4366172.html"),a("OutboundLink")],1)]),t._v(" "),a("li",[a("a",{attrs:{href:"https://github.com/jenkinsci/slack-plugin",target:"_blank",rel:"noopener noreferrer"}},[t._v("https://github.com/jenkinsci/slack-plugin"),a("OutboundLink")],1)]),t._v(" "),a("li",[a("a",{attrs:{href:"https://github.com/jenkinsci/dingtalk-plugin",target:"_blank",rel:"noopener noreferrer"}},[t._v("Jenkins 钉钉通知插件"),a("OutboundLink")],1)]),t._v(" "),a("li",[a("a",{attrs:{href:"http://www.mydlq.club/article/7/",target:"_blank",rel:"noopener noreferrer"}},[t._v("http://www.mydlq.club/article/7/"),a("OutboundLink")],1)])])])}),[],!1,null,null,null);s.default=e.exports}}]);