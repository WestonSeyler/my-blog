(window.webpackJsonp=window.webpackJsonp||[]).push([[198],{634:function(t,s,n){"use strict";n.r(s);var a=n(30),e=Object(a.a)({},(function(){var t=this,s=t.$createElement,n=t._self._c||s;return n("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[n("h4",{attrs:{id:"凭证-credentials"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#凭证-credentials"}},[t._v("#")]),t._v(" 凭证 Credentials")]),t._v(" "),n("p",[t._v("凭证可以是一段字符串如密码，私钥文件等，是Jenkins进行受限操作时的凭据。比如SSH登录远程服务器，用户名，密码或SSH key就是凭证。这些凭据不要明文写在Jenkinsfile中，Jenkins有专门管理凭证的地方和插件。")]),t._v(" "),n("h4",{attrs:{id:"添加凭证"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#添加凭证"}},[t._v("#")]),t._v(" 添加凭证")]),t._v(" "),n("p",[t._v("添加凭证步骤（需要有凭证权限，这里使用超级管理员身份）")]),t._v(" "),n("blockquote",[n("p",[n("img",{attrs:{src:"https://hexo-blog.pek3b.qingstor.com/upload_images/71414-1a7215e023c630cd.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240",alt:"image.png"}})])]),t._v(" "),n("blockquote",[n("p",[n("img",{attrs:{src:"https://hexo-blog.pek3b.qingstor.com/upload_images/71414-815d7322790bb209.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240",alt:"image.png"}})])]),t._v(" "),n("blockquote",[n("p",[n("img",{attrs:{src:"https://hexo-blog.pek3b.qingstor.com/upload_images/71414-224bc365af22dddc.png?imageMogr2/auto-orient/strip%7CimageView2/2/w/1240",alt:"image.png"}})])]),t._v(" "),n("p",[t._v("参数：")]),t._v(" "),n("ul",[n("li",[t._v("Kind | 凭证类型")]),t._v(" "),n("li",[t._v("Scope | 凭证作用域，分Global，用于pipeline就选这个，System，用于Jenkins系统本身，如电子邮件身份验证，代理连接等。")]),t._v(" "),n("li",[t._v("ID | 在pipeline中使用凭证的唯一标识 | 可以自己起，如果不填Jenkins会分配一个，必须唯一，而且创建后无法修改。建议自己起成容易识别的，比如 xxx-project-dingtalk-robot-token")])]),t._v(" "),n("p",[t._v("关于Kind凭证类型，有如下几种：")]),t._v(" "),n("ul",[n("li",[t._v("Username with password | 用户名和密码")]),t._v(" "),n("li",[t._v("Docker Host Certificate Authentication")]),t._v(" "),n("li",[t._v("SSH Username with private key | 一对SSH用户名和密钥")]),t._v(" "),n("li",[t._v("Secret file | 需要保密的文本文件，使用时Jenkins会将文件复制到一个临时目录中，再将文件路径设置到一个变量中，等构件结束后，所复制的Secret file就会被删除。")]),t._v(" "),n("li",[t._v("Secret text | 需要保存的一个保密的文本串，如钉钉机器人或Github的api token")]),t._v(" "),n("li",[t._v("Certificate")])]),t._v(" "),n("p",[t._v('添加凭证后，需要安装"Credentials Binding Plugin"插件，就可以在pipeline中使用withCredentials步骤使用凭证了。')]),t._v(" "),n("h4",{attrs:{id:"pipeline中使用凭证"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#pipeline中使用凭证"}},[t._v("#")]),t._v(" pipeline中使用凭证")]),t._v(" "),n("ul",[n("li",[t._v("withCredentials")])]),t._v(" "),n("div",{staticClass:"language- line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-text"}},[n("code",[t._v("// 通过 credentialsId 取出对应凭证，然后赋值给名为'my_dingtalk_token'(自己起)的变量\n// 根据变量在其他step中使用\nwithCredentials([string(credentialsId: 'dingding-robot-token', variable: 'my_dingtalk_token')]) {\n    // 注意：构建记录中只会输出 ****\n    echo \"${my_dingtalk_token}\"\n}\n")])]),t._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[t._v("1")]),n("br"),n("span",{staticClass:"line-number"},[t._v("2")]),n("br"),n("span",{staticClass:"line-number"},[t._v("3")]),n("br"),n("span",{staticClass:"line-number"},[t._v("4")]),n("br"),n("span",{staticClass:"line-number"},[t._v("5")]),n("br"),n("span",{staticClass:"line-number"},[t._v("6")]),n("br")])]),n("p",[t._v("比如钉钉讨论组建立机器人后会提供给你webhook的地址"),n("code",[t._v("https://oapi.dingtalk.com/robot/send?access_token=123456789abcde")]),t._v("，将后面的access_token 存到 Secret text 中。")]),t._v(" "),n("ul",[n("li",[t._v("credentials")])]),t._v(" "),n("p",[t._v("如果觉得withCredentials比较麻烦，声明式pipeline还提供了 helper 方法，在environment中使用credentials('credentials-id')就可以方便取出。")]),t._v(" "),n("blockquote",[n("p",[t._v("注意：credentials 指令只能使用在 environment 段中，而且目前只支持Secret text，Username with password 和 Secret file 三种。")])]),t._v(" "),n("div",{staticClass:"language-groovy line-numbers-mode"},[n("pre",{pre:!0,attrs:{class:"language-groovy"}},[n("code",[n("span",{pre:!0,attrs:{class:"token shebang comment"}},[t._v("#!groovy")]),t._v("\n\npipeline "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    agent any\n    environment "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        ding_robot_token "),n("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("credentials")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'dingding-robot-token'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\n    stages "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        "),n("span",{pre:!0,attrs:{class:"token function"}},[t._v("stage")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'debug'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n            steps "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n                sh "),n("span",{pre:!0,attrs:{class:"token string gstring"}},[t._v('"printenv"')]),t._v("\n            "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n        "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n    \n    post "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n        success "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n          script "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n            "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 输出 **** ，即在console中看不到真实信息")]),t._v("\n            echo "),n("span",{pre:!0,attrs:{class:"token string gstring"}},[t._v('"'),n("span",{pre:!0,attrs:{class:"token expression"}},[n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("$")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("env"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("ding_robot_token"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")])]),t._v('"')]),t._v("\n          "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n          "),n("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// 通知钉钉机器人，需要安装dingtalk插件")]),t._v("\n          dingTalk accessToken"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string gstring"}},[t._v('"'),n("span",{pre:!0,attrs:{class:"token expression"}},[n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("$")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("env"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("ding_robot_token"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")])]),t._v('"')]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" imageUrl"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("''")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" jenkinsUrl"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("''")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" message"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("'构建成功'")]),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" notifyPeople"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(":")]),t._v(" "),n("span",{pre:!0,attrs:{class:"token string"}},[t._v("''")]),t._v("\n        "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n  "),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n"),n("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])]),t._v(" "),n("div",{staticClass:"line-numbers-wrapper"},[n("span",{staticClass:"line-number"},[t._v("1")]),n("br"),n("span",{staticClass:"line-number"},[t._v("2")]),n("br"),n("span",{staticClass:"line-number"},[t._v("3")]),n("br"),n("span",{staticClass:"line-number"},[t._v("4")]),n("br"),n("span",{staticClass:"line-number"},[t._v("5")]),n("br"),n("span",{staticClass:"line-number"},[t._v("6")]),n("br"),n("span",{staticClass:"line-number"},[t._v("7")]),n("br"),n("span",{staticClass:"line-number"},[t._v("8")]),n("br"),n("span",{staticClass:"line-number"},[t._v("9")]),n("br"),n("span",{staticClass:"line-number"},[t._v("10")]),n("br"),n("span",{staticClass:"line-number"},[t._v("11")]),n("br"),n("span",{staticClass:"line-number"},[t._v("12")]),n("br"),n("span",{staticClass:"line-number"},[t._v("13")]),n("br"),n("span",{staticClass:"line-number"},[t._v("14")]),n("br"),n("span",{staticClass:"line-number"},[t._v("15")]),n("br"),n("span",{staticClass:"line-number"},[t._v("16")]),n("br"),n("span",{staticClass:"line-number"},[t._v("17")]),n("br"),n("span",{staticClass:"line-number"},[t._v("18")]),n("br"),n("span",{staticClass:"line-number"},[t._v("19")]),n("br"),n("span",{staticClass:"line-number"},[t._v("20")]),n("br"),n("span",{staticClass:"line-number"},[t._v("21")]),n("br"),n("span",{staticClass:"line-number"},[t._v("22")]),n("br"),n("span",{staticClass:"line-number"},[t._v("23")]),n("br"),n("span",{staticClass:"line-number"},[t._v("24")]),n("br"),n("span",{staticClass:"line-number"},[t._v("25")]),n("br"),n("span",{staticClass:"line-number"},[t._v("26")]),n("br"),n("span",{staticClass:"line-number"},[t._v("27")]),n("br")])]),n("h4",{attrs:{id:"进阶-使用-vault"}},[n("a",{staticClass:"header-anchor",attrs:{href:"#进阶-使用-vault"}},[t._v("#")]),t._v(" 进阶：使用 Vault")]),t._v(" "),n("p",[t._v("如果你要管理很多服务器密钥，数据库密码，用户密码或token等敏感信息，可以使用 "),n("a",{attrs:{href:"https://www.hashicorp.com/products/vault/",target:"_blank",rel:"noopener noreferrer"}},[t._v("Vault"),n("OutboundLink")],1),t._v("  他是hashicorp公司出品的专业管理机密和保护敏感数据的工具。")]),t._v(" "),n("p",[t._v("他有以下功能：")]),t._v(" "),n("ul",[n("li",[t._v("提供 图形化界面，CLI命令和HTTP API")]),t._v(" "),n("li",[t._v("方便的密码维护和变更管理功能，比如密码需要定期更换，使用Vault只需要在vault端更新密码，通知应用重新拉取就可以了")]),t._v(" "),n("li",[t._v("动态定期生成唯一密码，省去人工维护麻烦")]),t._v(" "),n("li",[t._v("支持 ACL，角色，策略，认证等")])]),t._v(" "),n("p",[t._v("安装非常简单，就一个二进制包，直接运行即可。具体使用请参考"),n("a",{attrs:{href:"%5Bhttps://learn.hashicorp.com/vault/getting-started/install%5D(https://learn.hashicorp.com/vault/getting-started/install)"}},[t._v("官方文档")]),t._v("写的非常清晰，再结合Jenkins的vault插件。就可以方便的管理凭证了。")])])}),[],!1,null,null,null);s.default=e.exports}}]);